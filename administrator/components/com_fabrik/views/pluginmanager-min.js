/*! Fabrik */
var PluginManager=my.Class({pluginTotal:0,topTotal:-1,constructor:function(a,b,c){var d,e=this;"string"==typeof a&&(a=[a]),this.id=b,this.plugins=a,this.type=c,$(document).ready(function(){for(d=0;d<a.length;d++)e.addTop(a[d]);e.watchPluginSelect(),e.watchDelete(),e.watchAdd();var b=$("#plugins");b.on("click","h3.title",function(){var a=$(this);b.find("h3.title").each(function(){$(this)!==a&&$(this).removeClass("pane-toggler-down")}),a.toggleClass("pane-toggler-down")}),e.watchDescriptions(b)})},watchDescriptions:function(a){a.on("keyup","input[name*=plugin_description]",function(){var a=$(this).closest(".actionContainer"),b=a.find(".pluginTitle"),c=a.find("select[name*=plugin]").val(),d=$(this).val();b.text(c+": "+d)})},canSaveForm:function(){return"complete"!==document.readyState?!1:Fabrik.requestQueue.empty()},watchDelete:function(){var a=this;$("#adminForm").on("click","a.removeButton, a[data-button=removeButton]",function(b){b.preventDefault(),a.pluginTotal--,a.topTotal--,a.deletePlugin(b)})},watchAdd:function(){var a=this;$("#addPlugin").on("click",function(b){b.stopPropagation(),a.addTop()})},addTop:function(a){var b,c,d,e,f=this;"string"==typeof a?(b=1,c=!1,a=a?a:"",d="",e=""):(b=a?a.published:1,c=a?a.show_icon:1,d=a?a.validate_in:"both",e=a?a.validation_on:"both",a=a?a.plugin:"");var g=$(document.createElement("div")).addClass("actionContainer panel accordion-group"),h=$(document.createElement("a")).addClass("accordion-toggle").attr({href:"#"}),i=Joomla.JText._("COM_FABRIK_LOADING").toLowerCase(),j=""!==a?a+" "+i:i;h.adopt($(document.createElement("span")).addClass("pluginTitle").text(j));var k=$(document.createElement("div")).addClass("title pane-toggler accordion-heading").adopt($(document.createElement("strong")).adopt(h)),l=$(document.createElement("div")).addClass("accordion-body");g.adopt(k),g.adopt(l),g.inject($("#plugins"));var m=this.topTotal+1,n={option:"com_fabrik",view:"plugin",task:"top",format:"raw",type:this.type,plugin:a,plugin_published:b,show_icon:c,validate_in:d,validation_on:e,c:this.topTotal,id:this.id},o=$.ajax({url:"index.php",data:n,update:l}).always(function(){Fabrik.debug&&fconsole("Fabrik pluginmanager: Adding",f.type,"entry",m.toString())}).done(function(){""!==a?f.addPlugin(a,m):k.find("span.pluginTitle").text(Joomla.JText._("COM_FABRIK_PLEASE_SELECT")),f.updateBootStrap(),FabrikAdmin.reTip()}).error(function(a,b){fconsole("Fabrik pluginmanager addTop ajax exception:",b)});this.topTotal++,Fabrik.requestQueue.add(o)},updateBootStrap:function(){$(".radio.btn-group label").addClass("btn"),jQuery.each($(".btn-group input[checked=checked]"),function(a,b){$("label[for="+b.prop("id")+"]").addClass(""===b.val()?"active btn-primary":"0"===b.val()?"active btn-danger":"active btn-success"),$("*[rel=tooltip]").tooltip()}),$(".hasTip").each(function(){var a=$(this).prop("title"),b=a.split("::",2);$(this).data("tip:title",b[0]),$(this).data("tip:text",b[1])});new Tips($(".hasTip"),{maxTitleChars:50,fixed:!1})},watchPluginSelect:function(){var a=this;$("#adminForm").on("change","select.elementtype",function(b){b.preventDefault();var c=$(this).val(),d=$(this).closest(".pluginContainer"),e=Joomla.JText._("COM_FABRIK_LOADING").toLowerCase(),f=""!==c?c+" "+e:e;$(this).closest(".actionContainer").find("span.pluginTitle").text(f);var g=parseInt(d.prop("id").replace("formAction_",""),10);a.addPlugin(c,g)})},addPlugin:function(a,b){var c=this;if(b="number"===typeOf(b)?b:this.pluginTotal,""===a)return void $("#plugins").find(".actionContainer")[b].find(".pluginOpts").empty();var d=new $.ajax({url:"index.php",data:{option:"com_fabrik",view:"plugin",format:"raw",type:this.type,plugin:a,c:b,id:this.id},update:$("#plugins").find(".actionContainer")[b].find(".pluginOpts"),onRequest:function(){Fabrik.debug&&fconsole("Fabrik pluginmanager: Loading",c.type,"type",a,"for entry",b.toString())},onSuccess:function(){var d=$("#plugins").find(".actionContainer")[b],e=d.find("span.pluginTitle"),f=a,g=d.find("input[name*=plugin_description]");g&&(f+=": "+g.val()),e.text(f),c.pluginTotal++,c.updateBootStrap(),FabrikAdmin.reTip()},onFailure:function(a){fconsole("Fabrik pluginmanager addPlugin ajax failed:",a)},onException:function(a,b){fconsole("Fabrik pluginmanager addPlugin ajax exception:",a,b)}});Fabrik.requestQueue.add(d)},deletePlugin:function(a){var b=$(a.target).closest("fieldset.pluginContainer");if(0!==b.length){if(Fabrik.debug&&fconsole("Fabrik pluginmanager: Deleting",this.type,"entry",b.id,"and renaming later entries"),b.id.match(/_\d+$/)){var c=parseInt(b.id.match(/_(\d+)$/)[1],10),d=$("#plugins");d.find("input, select, textarea, label, fieldset").each(function(){var a=this.name?this.name.match(/\[(\d+)\]/):null;if(!a&&this.id&&(a=this.id.match(/-(\d+)/)),!a&&"label"===$(this).prop("tagName").toLowerCase()&&$(this).prop("for")&&(a=$(this).prop("for").match(/-(\d+)/)),a){var b=parseInt(a[1],10);b>c&&(b--,this.name&&(this.name=this.name.replace(/(\[)(\d+)(\])/,"["+b+"]")),this.id&&(this.id=this.id.replace(/(-)(\d+)/,"-"+b)),"label"===$(this).prop("tagName").toLowerCase()&&$(this).prop("for")&&$(this).prop("for",$(this).prop("for").replace(/(-)(\d+)/,"-"+b)))}}),d.find("fieldset.pluginContainer").each(function(){if(this.id.match(/formAction_\d+$/)){var a=parseInt(this.id.match(/formAction_(\d+)$/)[1],10);a>c&&(a-=1,this.id=this.id.replace(/(formAction_)(\d+)$/,"$1"+a))}})}a.stopPropagation(),$(a.target).closest(".actionContainer").dispose()}}}),fabrikAdminPlugin=my.Class({options:{},constructor:function(a,b,c){this.name=a,this.label=b,this.options=$.extend(this.options,c)},cloned:function(){}});