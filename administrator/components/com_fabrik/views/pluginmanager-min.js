/*! Fabrik */
var PluginManager=my.Class({pluginTotal:0,topTotal:-1,constructor:function(a,b,c){"string"==typeof a&&(a=[a]),this.id=b,this.plugins=a,this.type=c,window.addEvent("domready",function(){var b;for(this.accordion=new Fx.Accordion([],[],{alwaysHide:!0,display:-1,duration:"short"}),b=0;b<a.length;b++)this.addTop(a[b]);this.periodical=setInterval(function(){this.iniAccordion.call(this,!0)},500),this.watchPluginSelect(),this.watchDelete(),this.watchAdd();var c=document.id("plugins");"null"!==typeOf(c)&&(c.addEvent("click:relay(h3.title)",function(a,b){jQuery.each(document.id("plugins").getElements("h3.title"),function(a,c){c!==b&&c.removeClass("pane-toggler-down")}),b.toggleClass("pane-toggler-down")}),this.watchDescriptions(c))}.bind(this))},watchDescriptions:function(a){a.addEvent("keyup:relay(input[name*=plugin_description])",function(a,b){var c=b.closest(".actionContainer"),d=c.find(".pluginTitle"),e=c.find("select[name*=plugin]").getValue(),f=b.getValue();d.set("text",e+": "+f)})},iniAccordion:function(){this.pluginTotal===this.plugins.length&&(this.accordion.display(1===this.plugins.length?0:-1),clearInterval(this.periodical))},canSaveForm:function(){return"complete"!==document.readyState?!1:Fabrik.requestQueue.empty()},watchDelete:function(){document.id("adminForm").addEvent("click:relay(a.removeButton, a[data-button=removeButton])",function(a){a.preventDefault(),this.pluginTotal--,this.topTotal--,this.deletePlugin(a)}.bind(this))},watchAdd:function(){var a=document.id("addPlugin");"null"!==typeOf(a)&&a.addEvent("click",function(a){a.stop(),this.accordion.display(-1),this.addTop()}.bind(this))},addTop:function(a){var b,c,d,e;"string"===typeOf(a)?(b=1,c=!1,a=a?a:"",d="",e=""):(b=a?a.published:1,c=a?a.show_icon:1,d=a?a.validate_in:"both",e=a?a.validation_on:"both",a=a?a.plugin:"");var f=new Element("div.actionContainer.panel.accordion-group"),g=new Element("a.accordion-toggle",{href:"#"});g.adopt(new Element("span.pluginTitle").set("text",""!==a?a+" "+Joomla.JText._("COM_FABRIK_LOADING").toLowerCase():Joomla.JText._("COM_FABRIK_LOADING")));var h=new Element("div.title.pane-toggler.accordion-heading").adopt(new Element("strong").adopt(g)),i=new Element("div.accordion-body");f.adopt(h),f.adopt(i),f.inject(document.id("plugins")),this.accordion.addSection(h,i);var j=this.topTotal+1,k={option:"com_fabrik",view:"plugin",task:"top",format:"raw",type:this.type,plugin:a,plugin_published:b,show_icon:c,validate_in:d,validation_on:e,c:this.topTotal,id:this.id},l=new Request.HTML({url:"index.php",data:k,update:i,onRequest:function(){Fabrik.debug&&fconsole("Fabrik pluginmanager: Adding",this.type,"entry",j.toString())}.bind(this),onSuccess:function(){""!==a?this.addPlugin(a,j):h.getElement("span.pluginTitle").set("text",Joomla.JText._("COM_FABRIK_PLEASE_SELECT")),this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this),onFailure:function(a){fconsole("Fabrik pluginmanager addTop ajax failed:",a)},onException:function(a,b){fconsole("Fabrik pluginmanager addTop ajax exception:",a,b)}});this.topTotal++,Fabrik.requestQueue.add(l)},updateBootStrap:function(){document.getElements(".radio.btn-group label").addClass("btn"),jQuery.each(document.getElements(".btn-group input[checked=checked]"),function(a,b){document.getElement("label[for="+b.get("id")+"]").addClass(""===b.get("value")?"active btn-primary":"0"===b.get("value")?"active btn-danger":"active btn-success"),"undefined"!=typeof jQuery&&jQuery("*[rel=tooltip]").tooltip()}),jQuery.each(document.getElements(".hasTip"),function(a,b){var c=b.get("title");if(c){var d=c.split("::",2);b.store("tip:title",d[0]),b.store("tip:text",d[1])}});new Tips($(".hasTip"),{maxTitleChars:50,fixed:!1})},watchPluginSelect:function(){document.id("adminForm").addEvent("change:relay(select.elementtype)",function(a,b){a.preventDefault();var c=b.get("value"),d=b.closest(".pluginContainer"),e=""!==c?c+" "+Joomla.JText._("COM_FABRIK_LOADING").toLowerCase():Joomla.JText._("COM_FABRIK_PLEASE_SELECT");b.closest(".actionContainer").find("span.pluginTitle").set("text",e);var f=d.id.replace("formAction_","").toInt();this.addPlugin(c,f)}.bind(this))},addPlugin:function(a,b){if(b="number"===typeOf(b)?b:this.pluginTotal,""===a)return void document.id("plugins").getElements(".actionContainer")[b].getElement(".pluginOpts").empty();var c=new Request.HTML({url:"index.php",data:{option:"com_fabrik",view:"plugin",format:"raw",type:this.type,plugin:a,c:b,id:this.id},update:document.id("plugins").getElements(".actionContainer")[b].getElement(".pluginOpts"),onRequest:function(){Fabrik.debug&&fconsole("Fabrik pluginmanager: Loading",this.type,"type",a,"for entry",b.toString())}.bind(this),onSuccess:function(){var c=document.id("plugins").getElements(".actionContainer")[b],d=c.getElement("span.pluginTitle"),e=a,f=c.getElement("input[name*=plugin_description]");f&&(e+=": "+f.getValue()),d.set("text",e),this.pluginTotal++,this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this),onFailure:function(a){fconsole("Fabrik pluginmanager addPlugin ajax failed:",a)},onException:function(a,b){fconsole("Fabrik pluginmanager addPlugin ajax exception:",a,b)}});Fabrik.requestQueue.add(c)},deletePlugin:function(a){var b=a.target.closest("fieldset.pluginContainer");if(0!==b.length){if(Fabrik.debug&&fconsole("Fabrik pluginmanager: Deleting",this.type,"entry",b.id,"and renaming later entries"),b.id.match(/_\d+$/)){var c=b.id.match(/_(\d+)$/)[1].toInt();jQuery.each(document.id("plugins").getElements("input, select, textarea, label, fieldset"),function(a,b){var d=b.name?b.name.match(/\[(\d+)\]/):null;if(!d&&b.id&&(d=b.id.match(/-(\d+)/)),!d&&"label"===b.get("tag").toLowerCase()&&b.get("for")&&(d=b.get("for").match(/-(\d+)/)),d){var e=d[1].toInt();e>c&&(e--,b.name&&(b.name=b.name.replace(/(\[)(\d+)(\])/,"["+e+"]")),b.id&&(b.id=b.id.replace(/(-)(\d+)/,"-"+e)),"label"===b.get("tag").toLowerCase()&&b.get("for")&&b.set("for",b.get("for").replace(/(-)(\d+)/,"-"+e)))}}),jQuery.each(document.id("plugins").getElements("fieldset.pluginContainer"),function(a,b){if(b.id.match(/formAction_\d+$/)){var d=b.id.match(/formAction_(\d+)$/)[1].toInt();d>c&&(d-=1,b.id=b.id.replace(/(formAction_)(\d+)$/,"$1"+d))}})}a.stop(),a.target.closest(".actionContainer").dispose()}}});fabrikAdminPlugin=my.Class({options:{},constructor:function(a,b,c){this.name=a,this.label=b,this.options=$.append(this.options,c)},cloned:function(){}});