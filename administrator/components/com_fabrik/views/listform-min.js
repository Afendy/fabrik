/*! Fabrik */
define(["jquery"],function(jQuery){var ListForm=new Class({autoChangeDbName:!0,Implements:[Options],options:{},initialize:function(a){var b;window.addEvent("domready",function(){this.setOptions(a),this.watchTableDd(),this.watchLabel(),document.id("addAJoin")&&document.id("addAJoin").addEvent("click",function(a){a.stop(),this.addJoin()}.bind(this)),document.getElement("table.linkedLists")&&(b=document.getElement("table.linkedLists").getElement("tbody"),new Sortables(b,{handle:".handle",onSort:function(){var a=this.serialize(1,function(a){return a.getElement("input")?a.getElement("input").name.split("][").getLast().replace("]",""):""}),b=[];a.each(function(a){""!==a&&b.push(a)}),document.getElement("input[name*=faceted_list_order]").value=JSON.stringify(b)}})),document.getElement("table.linkedForms")&&(b=document.getElement("table.linkedForms").getElement("tbody"),new Sortables(b,{handle:".handle",onSort:function(){var a=this.serialize(1,function(a){return a.getElement("input")?a.getElement("input").name.split("][").getLast().replace("]",""):""}),b=[];a.each(function(a){""!==a&&b.push(a)}),document.getElement("input[name*=faceted_form_order]").value=JSON.stringify(b)}})),this.joinCounter=0,this.watchOrderButtons(),this.watchDbName(),this.watchJoins()}.bind(this))},watchLabel:function(){this.autoChangeDbName=""===jQuery("#jform__database_name").val(),jQuery("#jform_label").on("keyup",function(){if(this.autoChangeDbName){var a=jQuery("#jform_label").val().trim().toLowerCase();a=a.replace(/\W+/g,"_"),jQuery("#jform__database_name").val(a)}}.bind(this)),jQuery("#jform__database_name").on("keyup",function(){this.autoChangeDbName=!1}.bind(this))},watchOrderButtons:function(){document.getElements(".addOrder").removeEvents("click"),document.getElements(".deleteOrder").removeEvents("click"),document.getElements(".addOrder").addEvent("click",function(a){a.stop(),this.addOrderBy()}.bind(this)),document.getElements(".deleteOrder").addEvent("click",function(a){a.stop(),this.deleteOrderBy(a)}.bind(this))},addOrderBy:function(a){var b;b=a?a.target.getParent(".orderby_container"):document.getElement(".orderby_container"),b.clone().inject(b,"after"),this.watchOrderButtons()},deleteOrderBy:function(a){document.getElements(".orderby_container").length>1&&(a.target.getParent(".orderby_container").dispose(),this.watchOrderButtons())},watchDbName:function(){document.id("database_name")&&document.id("database_name").addEvent("blur",function(){document.id("tablename").disabled=""===document.id("database_name").get("value")?!1:!0})},_buildOptions:function(a,b){var c=[];return a.length>0&&a.each("object"==typeof a[0]?function(a){c.push(a[0]===b?new Element("option",{value:a[0],selected:"selected"}).set("text",a[1]):new Element("option",{value:a[0]}).set("text",a[1]))}:function(a){c.push(a===b?new Element("option",{value:a,selected:"selected"}).set("text",a):new Element("option",{value:a}).set("text",a))}),c},watchTableDd:function(){document.id("tablename")&&document.id("tablename").addEvent("change",function(e){var cid=document.getElement("input[name*=connection_id]").get("value"),table=document.id("tablename").get("value"),url="index.php?option=com_fabrik&format=raw&task=list.ajax_updateColumDropDowns&cid="+cid+"&table="+table,myAjax=new Request({url:url,method:"post",onComplete:function(r){eval(r)}}).send()})},watchFieldList:function(a){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(select[name*="+a+"])",function(a,b){this.updateJoinStatement(b.getParent("tr").id.replace("join",""))}.bind(this))},_findActiveTables:function(){var a=document.getElements(".join_from").combine(document.getElements(".join_to"));a.each(function(a){var b=a.get("value");-1===this.options.activetableOpts.indexOf(b)&&this.options.activetableOpts.push(b)}.bind(this)),this.options.activetableOpts.sort()},addJoin:function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n;c=c?c:"left",g=g?g:"",d=d?d:"",e=e?e:"",f=f?f:"",a=a?a:"",b=b?b:"",j=j?j:!1,j?(k='checked="checked"',l=""):(l='checked="checked"',k=""),this._findActiveTables(),h=h?h:[["-",""]],i=i?i:[["-",""]];var o=new Element("tbody"),p=new Element("input",{readonly:"readonly",size:"2","class":"disabled readonly input-mini",name:"jform[params][join_id][]",value:b}),q=this.options.js?"btn-danger":"removeButton",r=new Element("a",{href:"#","class":"btn "+q,events:{click:function(a){return this.deleteJoin(a),!1}.bind(this)}}),s='<i class="icon-minus"></i> ';r.set("html",s),c=new Element("select",{name:"jform[params][join_type][]","class":"inputbox input-mini"}).adopt(this._buildOptions(this.options.joinOpts,c));var t=new Element("select",{name:"jform[params][join_from_table][]","class":"inputbox join_from input-medium"}).adopt(this._buildOptions(this.options.activetableOpts,g));a=new Element("input",{type:"hidden",name:"group_id[]",value:a});var u=new Element("select",{name:"jform[params][table_join][]","class":"inputbox join_to input-medium"}).adopt(this._buildOptions(this.options.tableOpts,d)),v=new Element("select",{name:"jform[params][table_key][]","class":"table_key inputbox input-medium"}).adopt(this._buildOptions(h,e));f=new Element("select",{name:"jform[params][table_join_key][]","class":"table_join_key inputbox input-medium"}).adopt(this._buildOptions(i,f));var w='<fieldset class="radio"><input type="radio" id="joinrepeat'+this.joinCounter+'" value="1" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+k+'/><label for="joinrepeat'+this.joinCounter+'">'+Joomla.JText._("JYES")+'</label><input type="radio" id="joinrepeatno'+this.joinCounter+'" value="0" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+l+'/><label for="joinrepeatno'+this.joinCounter+'">'+Joomla.JText._("JNO")+"</label></fieldset>";m=new Element("thead").adopt(new Element("tr").adopt([new Element("th").set("text","id"),new Element("th").set("text",Joomla.JText._("COM_FABRIK_JOIN_TYPE")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_REPEAT_GROUP_BUTTON_LABEL")),new Element("th")])),n=new Element("tr",{id:"join"+this.joinCounter}).adopt([new Element("td").adopt(p),new Element("td").adopt([a,c]),new Element("td").adopt(t),new Element("td").adopt(u),new Element("td.table_key").adopt(v),new Element("td.table_join_key").adopt(f),new Element("td").set("html",w),new Element("td").adopt(r)]);var x=new Element("table",{"class":"table-striped table"}).adopt([m,o.adopt(n)]);if(0===this.joinCounter)x.inject(document.id("joindtd"));else{var y=document.id("joindtd").getElement("tbody");n.inject(y)}this.joinCounter++},deleteJoin:function(a){var b,c;a.stop(),c=a.target.getParent("tr"),b=a.target.getParent("table"),c.dispose(),0===b.getElements("tbody tr").length&&b.dispose()},watchJoins:function(){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_from)",function(a,b){var c=b.getParent("tr"),d=c.id.replace("join","");this.updateJoinStatement(d);{var e=b.get("value"),f=document.getElement("input[name*=connection_id]").get("value"),g=c.getElement("td.table_key"),h="index.php?option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+e+"&conn="+f;new Request.HTML({url:h,method:"post",update:g}).send()}}.bind(this)),document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_to)",function(a,b){var c=b.getParent("tr"),d=c.id.replace("join","");this.updateJoinStatement(d);{var e=b.get("value"),f=document.getElement("input[name*=connection_id]").get("value"),g="index.php?name=jform[params][table_join_key][]&option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+e+"&conn="+f,h=c.getElement("td.table_join_key");new Request.HTML({url:g,method:"post",update:h}).send()}}.bind(this)),this.watchFieldList("join_type"),this.watchFieldList("table_join_key"),this.watchFieldList("table_key")},updateJoinStatement:function(a){var b=document.getElements("#join"+a+" .inputbox");b=Array.from(b);var c=b[0].get("value"),d=b[1].get("value"),e=b[2].get("value"),f=b[3].get("value"),g=b[4].get("value"),h=c+" JOIN "+e+" ON "+d+"."+f+" = "+e+"."+g,i=document.id("join-desc-"+a);"null"!==typeOf(i)&&i.set("html",h)}});return ListForm});