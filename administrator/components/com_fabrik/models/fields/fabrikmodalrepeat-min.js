/*! Fabrik */
"use strict";var FabrikModalRepeat=my.Class({options:{j3:!0},constructor:function(a,b,c,d){this.names=b,this.field=c,this.content=!1,this.setup=!1,this.elid=a,this.win={},this.el={},this.field={},this.options=$.append(this.options,d),this.ready()?this.setUp():this.timer=setInterval(function(){this.testReady.call(this,!0)},500)},ready:function(){return"null"===typeOf(document.id(this.elid))?!1:!0},testReady:function(){this.ready()&&(this.timer&&clearInterval(this.timer),this.setUp())},setUp:function(){this.button=document.id(this.elid+"_button"),this.mask=new Mask(document.body,{style:{"background-color":"#000",opacity:.4,"z-index":9998}}),$(document).on("click","*[data-modal="+this.elid+"]",function(a){a.preventDefault();var b,c=$(this).next("input").id,d=$(this).closest("li");this.field[c]=$(this).next("input"),d||(d=$(this).closest("div.control-group")),this.origContainer=d,b=d.find("table"),b.length>0&&(this.el[c]=b),this.openWindow(c)}.bind(this))},openWindow:function(a){var b=!1;this.win[a]||(b=!0,this.makeTarget(a)),this.el[a].inject(this.win[a],"top"),this.el[a].show(),(!this.win[a]||b)&&this.makeWin(a),this.win[a].show(),this.win[a].position(),this.resizeWin(!0,a),this.win[a].position(),this.mask.show()},makeTarget:function(a){this.win[a]=new Element("div",{"data-modal-content":a,styles:{padding:"5px","background-color":"#fff",display:"none","z-index":9999}}).inject(document.body)},makeWin:function(a){var b=new Element("button.btn.button.btn-primary").set("text","close");b.addEvent("click",function(b){b.stop(),this.store(a),this.el[a].hide(),this.el[a].inject(this.origContainer),this.close()}.bind(this));var c=new Element("div.controls.form-actions",{styles:{"text-align":"right","margin-bottom":0}}).adopt(b);this.win[a].adopt(c),this.win[a].position(),this.content=this.el[a],this.build(a),this.watchButtons(this.win[a],a)},resizeWin:function(a){Object.each(this.win,function(b,c){var d=this.el[c].getDimensions(!0),e=b.getDimensions(!0);if(b.setStyles({width:d.x+"px"}),"undefined"!=typeof Fabrik&&!Fabrik.bootstrapped){var f=a?e.y:d.y+30;b.setStyle("height",f+"px")}}.bind(this))},close:function(){Object.each(this.win,function(a){a.hide()}),this.mask.hide()},_getRadioValues:function(a){var b,c=[];return jQuery.each(this.getTrs(a),function(a,d){var e=(b=d.getElement("input[type=radio]:checked"))?b.get("value"):"";c.push(e)}),c},_setRadioValues:function(a,b){var c;jQuery.each(this.getTrs(b),function(b,d){(c=d.getElement("input[type=radio][value="+a[b]+"]"))&&(c.checked="checked")})},addRow:function(a,b){var c=this._getRadioValues(a),d=b.closest("table").find("tbody"),e=this.tmpl.clone(!0,!0);e.inject(d),this.stripe(a),this.fixUniqueAttributes(b,e),this._setRadioValues(c,a),this.resizeWin(!1,a),this.resetChosen(e)},fixUniqueAttributes:function(a,b){var c=a.closest("table").find("tr").length-1;jQuery.each(b.getElements("*[name]"),function(a,b){b.name+="-"+c}),jQuery.each(b.getElements("*[id]"),function(a,b){b.id+="-"+c}),jQuery.each(b.getElements("label[for]"),function(a,b){b.label+="-"+c})},watchButtons:function(a,b){var c;a.addEvent("click:relay(a.add)",function(d){(c=this.findTr(d))&&this.addRow(b,c),a.position(),d.stop()}.bind(this)),a.addEvent("click:relay(a.remove)",function(d){(c=this.findTr(d))&&c.dispose(),this.resizeWin(!1,b),a.position(),d.stop()}.bind(this))},resetChosen:function(a){this.options.j3&&jQuery&&"null"!==typeOf(jQuery("select").chosen)&&(a.getElements("select").removeClass("chzn-done").show(),jQuery(a.getElements("select"),function(a,b){b.id=b.id+"_"+(1e7*Math.random()).toInt()}),a.getElements(".chzn-container").destroy(),jQuery(a).find("select").chosen({disable_search_threshold:10,allow_single_deselect:!0}))},getTrs:function(a){return this.win[a].getElement("tbody").getElements("tr")},stripe:function(a){for(var b=this.getTrs(a),c=0;c<b.length;c++)b[c].removeClass("row1").removeClass("row0"),b[c].addClass("row"+c%2)},build:function(a){this.win[a]||this.makeWin(a);var b=JSON.decode(this.field[a].get("value"));"null"===typeOf(b)&&(b={});for(var c=this.win[a].getElement("tbody").getElement("tr"),d=Object.keys(b),e=0===d.length||0===b[d[0]].length?!0:!1,f=e?1:b[d[0]].length,g=1;f>g;g++){var h=c.clone();this.fixUniqueAttributes(c,h),h.inject(c,"after"),this.resetChosen(h)}this.stripe(a);var i=this.getTrs(a);for(g=0;f>g;g++)d.each(function(a){jQuery.each(i[g].getElements("*[name*="+a+"]"),function(c,d){"radio"===d.get("type")?d.value===b[a][g]&&(d.checked=!0):(d.value=b[a][g],"select"===d.get("tag")&&"undefined"!=typeof jQuery&&jQuery(d).trigger("liszt:updated"))})});this.tmpl=c,e&&c.dispose()},findTr:function(a){var b=a.target.getParents().filter(function(a){return"tr"===a.get("tag")});return 0===b.length?!1:b[0]},store:function(a){var b=this.content;b=this.el[a];for(var c={},d=0;d<this.names.length;d++){var e=this.names[d],f=b.getElements("*[name*="+e+"]");c[e]=[],f.each(function(a){"radio"===a.get("type")?a.get("checked")===!0&&c[e].push(a.get("value")):c[e].push(a.get("value"))}.bind(this))}return this.field[a].value=JSON.encode(c),!0}});