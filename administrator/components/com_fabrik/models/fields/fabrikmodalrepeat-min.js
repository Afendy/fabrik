/*! Fabrik */
"use strict";var FabrikModalRepeat=my.Class({options:{j3:!0},constructor:function(a,b,c,d){var e=this;if(this.names=b,this.field=c,this.content=!1,this.setup=!1,this.elid=a,this.win={},this.el={},this.field={},this.options=$.extend(this.options,d),this.ready())this.setUp();else{var f=function(){e.testReady.call(e,!0)};this.timer=setInterval(f,500)}},ready:function(){return jQuery("#"+this.elid).length>0},testReady:function(){this.ready()&&(this.timer&&clearInterval(this.timer),this.setUp())},setUp:function(){var a=this;this.button=jQuery("#"+this.elid+"_button"),this.mask=new Mask(document.body,{style:{"background-color":"#000",opacity:.4,"z-index":9998}}),jQuery(document).on("click","*[data-modal="+this.elid+"]",function(b){b.preventDefault();var c,d=jQuery(this).next("input").prop("id"),e=jQuery(this).closest("div.control-group");a.field[d]=$(this).next("input"),a.origContainer=e,c=e.find("table"),c.length>0&&(a.el[d]=c),a.openWindow(d)})},openWindow:function(a){var b=!1;this.win[a]||(b=!0,this.makeTarget(a)),this.el[a].prependTo(this.win[a]),this.el[a].show(),(!this.win[a]||b)&&this.makeWin(a),this.win[a].show(),this.win[a].position(),this.resizeWin(),this.win[a].position(),this.mask.show()},makeTarget:function(a){this.win[a]=jQuery(document.createElement("div")).data("modal-content",a).css({padding:"5px","background-color":"#fff",display:"none","z-index":9999}).prependTo(document.body)},makeWin:function(a){var b=this,c=jQuery(document.createElement("button")).addClass("btn button btn-primary").text("close");c.on("click",function(c){c.stopPropagation(),b.store(a),b.el[a].hide(),b.el[a].inject(b.origContainer),b.close()});var d=jQuery(document.createElement("div")).addClass("controls form-actions").css({"text-align":"right","margin-bottom":0}).append(c);this.win[a].append(d),this.win[a].position(),this.content=this.el[a],this.build(a),this.watchButtons(this.win[a],a)},resizeWin:function(){var a=this;Object.each(this.win,function(b,c){b.css({width:a.el[c].width()+"px"})})},close:function(){Object.each(this.win,function(a){a.hide()}),this.mask.hide()},_getRadioValues:function(a){var b=[];return this.getTrs(a).each(function(){var a=$(this).find("input[type=radio]:checked").val();b.push(a)}),b},_setRadioValues:function(a,b){this.getTrs(b).each(function(b){$(this).find("input[type=radio][value="+a[b]+"]").prop("checked",!0)})},addRow:function(a,b){var c=this._getRadioValues(a),d=b.closest("table").find("tbody"),e=this.tmpl.clone(!0,!0);e.appendTo(d),this.stripe(a),this.fixUniqueAttributes(b,e),this._setRadioValues(c,a),this.resizeWin(),this.resetChosen(e)},fixUniqueAttributes:function(a,b){var c=a.closest("table").find("tr").length-1;jQuery.each(b.find("*[name]"),function(){$(this).prop("name",$(this).prop("name")+"-"+c)}),jQuery.each(b.find("*[id]"),function(){$(this).prop("id",$(this).prop("id")+"-"+c)}),jQuery.each(b.find("label[for]"),function(){$(this).prop("label",$(this).prop("label")+"-"+c)})},watchButtons:function(a,b){var c,d=this;a.on("click","a.add",function(e){(c=d.findTr(e))&&d.addRow(b,c),a.position(),e.stopPropagation()}),a.on("click","a.remove",function(b){(c=d.findTr(b))&&c.remove(),d.resizeWin(),a.position(),b.stopPropagation()})},resetChosen:function(a){jQuery("select").chosen&&(a.find("select").removeClass("chzn-done").show(),jQuery(a.find("select"),function(){$(this).prop("id",$(this).prop("id")+"_"+parseInt(1e7*Math.random(),10))}),a.find(".chzn-container").destroy(),jQuery(a).find("select").chosen({disable_search_threshold:10,allow_single_deselect:!0}))},getTrs:function(a){return this.win[a].find("tbody").find("tr")},stripe:function(a){for(var b=this.getTrs(a),c=0;c<b.length;c++)b[c].removeClass("row1").removeClass("row0"),b[c].addClass("row"+c%2)},build:function(a){this.win[a]||this.makeWin(a);var b=JSON.decode(this.field[a].val());"null"===typeOf(b)&&(b={});for(var c=this.win[a].find("tbody").find("tr"),d=Object.keys(b),e=0===d.length||0===b[d[0]].length?!0:!1,f=e?1:b[d[0]].length,g=1;f>g;g++){var h=c.clone();this.fixUniqueAttributes(c,h),h.inject(c,"after"),this.resetChosen(h)}this.stripe(a);var i=this.getTrs(a);for(g=0;f>g;g++)d.each(function(a){jQuery.each(i[g].find("*[name*="+a+"]"),function(c,d){"radio"===$(this).prop("type")?d.value===b[a][g]&&(d.checked=!0):(d.value=b[a][g],"SELECT"===d.prop("tagName")&&$(d).trigger("liszt:updated"))})});this.tmpl=c,e&&c.remove()},findTr:function(a){return $(a.target).closest("tr")},store:function(a){var b,c,d,e=this.el[a],f={};for(b=0;b<this.names.length;b++)c=this.names[b],d=e.find("*[name*="+c+"]"),f[c]=this.getStoreFieldValues(d);return this.field[a].value=JSON.encode(f),!0},getStoreFieldValues:function(a){var b=[];return a.each(function(){"radio"===$(this).prop("type")?$(this).prop("checked")===!0&&b.push($(this).val()):b.push($(this).val())}),b}});