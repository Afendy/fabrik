/*! Fabrik */
var fabriktablesElement=my.Class({options:{conn:null,connInRepeat:!0,container:""},constructor:function(a,b){this.el=a,this.options=$.extend(this.options,b),this.elements=[],this.elementLists={},this.waitingElements={},$("#"+this.options.conn).length>0?this.periodical=setInterval(function(){this.getCnn.call(this,!0)},500):this.setUp()},getCnn:function(){0!==$("#"+this.options.conn.length)&&(this.setUp(),clearInterval(this.periodical))},registerElement:function(a){this.elements.push(a),this.updateElements()},setUp:function(){if(this.el=$("#"+this.el),this.cnn=$("#"+this.options.conn),"null"!==this.cnn){this.loader=$("#"+this.el.id+"_loader");var a=this;this.cnn.hasClass("chzn-done")&&jQuery("#"+this.cnn.id).on("change",function(){$("#"+a.cnn).trigger("change")}),this.cnn.on("change",function(b){a.updateMe(b)}),this.el.hasClass("chzn-done")&&jQuery("#"+this.el.id).on("change",function(){$("#"+a.el.id).trigger("change")}),this.el.on("change",function(b){a.updateElements(b)});var b=this.cnn.val();""!==b&&-1!==b&&this.updateMe()}},updateMe:function(a){var b=this;a&&a.stopPropagation();var c=this.cnn.val();if(c){this.loader&&this.loader.show();var d=$.getJSON({url:"index.php",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_tables",showf:"1",cid:parseInt(c,10)}}).fail(function(a,b,c){console.log("fabriktables request exception",b,c)}).done(function(a){a.err?window.alert(a.err):(b.el.empty(),a.each(function(a){var c={value:a.id};a.id===b.options.value&&(c.selected="selected"),$(document.createElement("option")).attr(c).text(a.label).inject(this.el)}),b.loader&&b.loader.hide(),b.el.hasClass("chzn-done")&&$("#"+this.el.id).trigger("liszt:updated"),this.updateElements())});Fabrik.requestQueue.add(d)}},updateElements:function(){var a=this;this.elements.each(function(b){var c=b.getOpts(),d=this.el.val();if(""!==d){this.loader&&this.loader.show();var e=c.getValues().toString()+","+d;if(this.waitingElements.hasOwnProperty(e)||(this.waitingElements[e]={}),void 0!==this.elementLists[e])""===this.elementLists[e]?this.waitingElements[e][b.el.id]=b:this.updateElementOptions(this.elementLists[e],b);else{var f=this.cnn.val();this.elementLists[e]="";var g={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_fields",cid:parseInt(f,10),showf:"1",k:"2",t:d};c.each(function(a,b){g[b]=a}),new $.ajax({url:"index.php",data:g}).done(function(c){a.elementLists[e]=c,a.updateElementOptions(c,b),$.each(a.waitingElements[e],function(b,d){a.updateElementOptions(c,d),delete a.waitingElements[e][b]})}).fail(function(b,c,d){$.each(this.waitingElements[e],function(b,c){a.updateElementOptions("[]",c),delete a.waitingElements[e][b]}),a.loader&&a.loader.hide(),window.alert(c+" "+d)})}}}.bind(this))},updateElementOptions:function(r,element){var target,dotValue;if(""!==r){var table=$("#"+this.el).val(),key=element.getOpts().getValues().toString()+","+table,opts=eval(r);target="TEXTAREA"===element.el.prop("tagName")?element.el.parent().find("select"):element.el,target.empty();var o={value:""};""===element.options.value&&(o.selected="selected"),$(document.createElement("option")).attr(o).text("-").inject(target),dotValue=element.options.value.replace(".","___"),opts.each(function(a){var b=a.value.replace("[]",""),c={value:b};(b===element.options.value||b===dotValue)&&(c.selected="selected"),$(document.createElement("option")).attr(c).text(a.label).inject(target)}.bind(this)),this.loader&&this.loader.hide()}},cloned:function(a,b){if(this.options.connInRepeat===!0){var c=this.options.conn.split("-");c.pop(),this.options.conn=c.join("-")+"-"+b}this.el=a,this.elements=[],this.elementLists={},this.waitingElements={},this.setUp(),FabrikAdmin.model.fields.fabriktable[this.el.id]=this}});