/*! Fabrik */
AdvancedSearch=my.Class({options:{ajax:!1,controller:"list",parentView:"",defaultStatement:"="},constructor:function(a){var b=this.form.find(".advanced-search-add"),c=this.form.find(".advanced-search-clearall"),d=this;this.options=$.extend(this.options,a),this.form=$("#advanced-search-win"+this.options.listref).find("form"),this.trs=Array.from([]),b.length>0&&(b.off("click"),b.on("click",function(a){d.addRow(a)}),c.off("click"),c.on("click",function(a){d.resetForm(a)}),this.trs.each(function(a){a.inject(d.form.find(".advanced-search-list").find("tr").last(),"after")})),this.form.on("click","tr",function(){d.form.find("tr").removeClass("fabrikRowClick"),$(this).addClass("fabrikRowClick")}),this.watchDelete(),this.watchApply(),this.watchElementList(),Fabrik.trigger("fabrik.advancedSearch.ready",this)},watchApply:function(){var a=this;this.form.find(".advanced-search-apply").on("click",function(b){Fabrik.trigger("fabrik.advancedSearch.submit",this);var c=Fabrik["filter_"+this.options.parentView];"null"!==typeOf(c)&&c.onSubmit();var d=a.getList();$(document.createElement("input")).attr({name:"resetfilters",value:1,type:"hidden"}).inject(a.form),a.options.ajax&&(b.stopPropagation(),d.submit(a.options.controller+".filter"))})},getList:function(){var a=Fabrik.blocks["list_"+this.options.listref];return void 0===a&&(a=Fabrik.blocks[this.options.parentView]),a},watchDelete:function(){var a=this.form.find(".advanced-search-remove-row"),b=this;a.off(),a.on("click",function(a){b.removeRow(a)})},watchElementList:function(){var a=this.form.find("select.key"),b=this;a.off(),a.on("change",function(a){b.updateValueInput(a)})},updateValueInput:function(a){var b,c=$(a.target).closest("tr"),d="index.php?option=com_fabrik&task=list.elementFilter&format=raw";Fabrik.loader.start(c);var e=$(a.target).val(),f=$(a.target).parent().parent().find("td")[3];return""===e?void f.html(""):(b=this.options.elementMap[e],void $.ajax({url:d,update:f,data:{element:e,id:this.options.listid,elid:b.id,plugin:b.plugin,counter:this.options.counter,listref:this.options.listref,context:this.options.controller,parentView:this.options.parentView}}).done(function(){Fabrik.loader.stop(c)}))},addRow:function(a){this.options.counter++,a.stopPropagation();var b=this.form.find(".advanced-search-list").find("tbody").find("tr").last(),c=b.clone();c.removeClass("oddRow1").removeClass("oddRow0").addClass("oddRow"+this.options.counter%2),c.inject(b,"after"),c.find("td").empty().html(this.options.conditionList);var d=c.find("td");d[1].empty().html(this.options.elementList),d[1].adopt([$(document.createElement("input")).attr({type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][search_type][]",value:"advanced"}),$(document.createElement("input")).attr({type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][grouped_to_previous][]",value:"0"})]),d[2].empty().html(this.options.statementList),d[3].empty(),this.watchDelete(),this.watchElementList(),Fabrik.trigger("fabrik.advancedSearch.row.added",this)},removeRow:function(a){if(a.stopPropagation(),this.form.find(".advanced-search-remove-row").length>1){this.options.counter--;var b=a.target.closest("tr"),c=new Fx.Morph(b,{duration:800,transition:Fx.Transitions.Quart.easeOut,onComplete:function(){b.remove()}});c.start({height:0,opacity:0})}Fabrik.trigger("fabrik.advancedSearch.row.removed",this)},resetForm:function(){var a=this.form.find(".advanced-search-list"),b=this;a&&(a.find("tbody tr").each(function(a){a>=1&&$(this).remove(),0===a&&($(this).find(".inputbox").each(function(){$(this).id.test(/condition$/)?$(this).value=b.options.defaultStatement:$(this).selectedIndex=0}),$(this).find("input").each(function(){$(this).value=""}))}),this.watchDelete(),this.watchElementList(),Fabrik.trigger("fabrik.advancedSearch.reset",this))},deleteFilterOption:function(a){var b=this;$(a.target).removeEvent("click",function(a){b.deleteFilterOption(a)});var c=$(a.target).parent().parent(),d=c.parent();d.removeChild(c),a.stopPropagation()}});