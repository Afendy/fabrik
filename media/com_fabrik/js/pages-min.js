/*! Fabrik */
var Pages=my.Class({constructor:function(a,b){this.editable=b;var c=this;$(document).on("mousedown",function(a){c.clearActive(a)}),Fabrik.addEvent("fabrik.page.add",function(a){c.makeActive(a)}),this.pages={},this.activePage=null,this.container=document.id(a),Fabrik.addEvent("fabrik.tab.add",function(a){this.add(a)}.bind(this)),Fabrik.addEvent("fabrik.tab.click",function(a){this.show(a)}.bind(this)),Fabrik.addEvent("fabrik.tab.remove",function(a){this.remove(a)}.bind(this)),Fabrik.addEvent("fabrik.keynav",function(a){this.moveItem(a)}.bind(this)),Fabrik.addEvent("fabrik.inline.save",function(a){this.updateTabKey(a)}.bind(this))},makeActive:function(a){this.clearActive(),a.addClass("active"),this.active=a;var b=document.getElements(".itemPlaceHolder").getStyle("z-index").sort(),c=b.getLast().toInt()+1;document.getElements(".itemPlaceHolder").each(function(a){a.setStyle("zindex",a.getStyle("z-index").toInt()-1)}),a.setStyle("z-index",c)},clearActive:function(){delete this.active,document.getElements(".itemPlaceHolder").removeClass("active")},moveItem:function(a,b){if(this.active&&this.editable){b=b?10:0;var c=this.active.getCoordinates(this.getActivePage().page);switch(a){case 37:this.active.setStyle("left",c.left-2-b);break;case 38:this.active.setStyle("top",c.top-2-b);break;case 39:this.active.setStyle("left",c.left+1+b);break;case 40:this.active.setStyle("top",c.top+1+b)}}},add:function(a,b){var c=new Page(b,this.editable);this.container.adopt(c.page),c.show(),this.pages[b]=c,this.show()},remove:function(a,b){b=b.retrieve("ref"),delete this.pages[b]},show:function(a){jQuery.each(this.pages,function(a,b){b.hide()});try{this.pages[a].show(),this.activePage=a}catch(b){var c=Object.keys(this.pages);c.length>0&&(a=c[0],this.pages[a].show(),this.activePage=a)}},getHTMLPages:function(){var a=[];return jQuery.each(this.pages,function(b,c){a.push(c.page)}),a},getActivePage:function(){return this.activePage||(this.activePage=0),this.pages[this.activePage]},fromJSON:function(a){jQuery.each(a,function(a,b){this.pages[a]&&jQuery.each(b,function(b,c){this.pages[a].insert(c.id,c.label,c.type,c.dimensions)}.bind(this))}.bind(this))},toJSON:function(){var a={};return jQuery.each(this.pages,function(b,c){var d={};jQuery.each(c.page.getElements(".itemPlaceHolder"),function(a,b){c.page.show();var e=b.id.split("_")[0],f=b.getElement(".handlelabel").get("text");d[b.id]={dimensions:b.getCoordinates(c.page),label:f,type:e,id:b.id}}),a[b.trim()]=d}),a},updateTabKey:function(a){var b=a.retrieve("origValue").trim(),c=this.pages[b];this.pages[a.get("text").trim()]=c,delete this.pages[b]}});Page=my.Class({constructor:function(a,b){this.editable=b,this.page=new Element("div",{"class":"page",styles:{display:"none"}}),this.editable&&(Fabrik.addEvent("fabrik.item.resized",function(a){this.saveCoords(a)}.bind(this)),Fabrik.addEvent("fabrik.item.moved",function(a){this.saveCoords(a)}.bind(this)))},show:function(){this.page.show()},hide:function(){this.page.hide()},remove:function(){this.page.destroy()},removeItem:function(a,b){a.stop(),confirm("Do you really want to delete")&&(document.id(b).destroy(),Fabrik.trigger("fabrik.page.block.delete",[b]))},insert:function(a,b,c,d){Fabrik.trigger("fabrik.page.insert",[this,a,b,c,d])},saveCoords:function(){}});