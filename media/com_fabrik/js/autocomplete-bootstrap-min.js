/*! Fabrik */
var FbAutocomplete=my.Class({options:{menuclass:"auto-complete-container dropdown",classes:{ul:"dropdown-menu",li:"result"},url:"index.php",max:10,onSelection:Class.empty,autoLoadSingleResult:!0,minTriggerChars:1,storeMatchedResultsOnly:!1},initialize:function(a,b){var c=this;window.addEvent("domready",function(){return this.matchedResult=!1,this.setOptions(b),a=a.replace("-auto-complete",""),this.options.labelelement="null"===typeOf(document.id(a+"-auto-complete"))?document.find(a+"-auto-complete"):document.id(a+"-auto-complete"),this.cache={},this.selected=-1,this.mouseinsde=!1,$(document).on("keydown",function(a){c.doWatchKeys(a)}),this.element="null"===typeOf(document.id(a))?document.find(a):document.id(a),this.buildMenu(),this.getInputElement()?(this.getInputElement().setProperty("autocomplete","off"),this.getInputElement().addEvent("keyup",function(a){this.search(a)}.bind(this)),void this.getInputElement().addEvent("blur",function(){this.options.storeMatchedResultsOnly&&(this.matchedResult||"undefined"!=typeof this.data&&1===this.data.length&&this.options.autoLoadSingleResult||(this.element.value=""))}.bind(this))):void fconsole("autocomplete didn't find input element")}.bind(this))},search:function(a){var b=this;if(this.isMinTriggerlength()){if("tab"===a.key||"enter"===a.key)return a.stopPropagation(),this.closeMenu(),this.ajax&&this.ajax.cancel(),void this.element.trigger("change",new jQuery.Event("change"),500);this.matchedResult=!1;var c=this.getInputElement().get("value");""===c&&(this.element.value=""),c!==this.searchText&&""!==c&&(this.options.storeMatchedResultsOnly===!1&&(this.element.value=c),this.positionMenu(),this.cache[c]?this.populateMenu(this.cache[c])&&this.openMenu():(this.ajax&&(this.closeMenu(),this.ajax.cancel()),this.ajax=$.ajax({url:this.options.url,data:{value:c}}).fail(function(a,c,d){Fabrik.loader.stop(b.getInputElement()),b.ajax=null,fconsole("Fabrik autocomplete: Ajax failure: Code "+c+": "+d);var e=Fabrik.getBlock(b.options.formRef).formElements.get(this.element.prop("id"));e.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",!0)}).always(function(){Fabrik.loader.start(b.getInputElement())}).done(function(a){if(Fabrik.loader.stop(b.getInputElement()),b.ajax=null,"null"===typeOf(a)){fconsole("Fabrik autocomplete: Ajax response empty");var d=Fabrik.getBlock(this.options.formRef).formElements.get(this.element.prop("id"));return void d.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",!0)}this.completeAjax(a,c)}))),this.searchText=c}},completeAjax:function(a,b){a=JSON.decode(a),this.cache[b]=a,this.populateMenu(a)&&this.openMenu()},buildMenu:function(){this.menu=$("<ul />").addClass("dropdown-menu").attr({role:"menu"}).css({"z-index":1056}),this.menu.inject(document.body),this.menu.addEvent("mouseenter",function(){this.mouseinsde=!0}.bind(this)),this.menu.addEvent("mouseleave",function(){this.mouseinsde=!1}.bind(this)),this.menu.addEvent("click:relay(a)",function(a,b){this.makeSelection(a,b)}.bind(this))},getInputElement:function(){return this.options.labelelement?this.options.labelelement:this.element},positionMenu:function(){var a=this.getInputElement().getCoordinates();this.menu.setStyles({left:a.left,top:a.top+a.height-1,width:a.width})},populateMenu:function(a){var b,c,d,e,f,g;a.map(function(a){return a.text=Encoder.htmlDecode(a.text),a}),this.data=a;var h=this.getListMax(),i=this.menu;if(i.empty(),1===a.length&&this.options.autoLoadSingleResult)return this.element.value=a[0].value,this.getInputElement().value=a[0].text,this.closeMenu(),this.trigger("selection",[this,this.element.value]),d=Fabrik.getBlock(this.options.formRef),d!==!1&&(e=d.formElements.get(this.element.id),f=e.getBlurEvent(),this.element.trigger(f,jQuery.Event(f),700)),Fabrik.trigger("fabrik.autocomplete.selected",[this,this.element.value]),!1;0===a.length&&(b=$("<li />").adopt($("<div />").addClass(" alert alert-info").adopt($("<i>").text(Joomla.JText._("COM_FABRIK_NO_RECORDS")))),b.inject(i));for(var j=0;h>j;j++)g=a[j],c=$("<a>").attr({href:"#","data-value":g.value,tabindex:"-1"}).text(g.text),b=$("<li>").adopt(c),b.inject(i);return a.length>this.options.max&&$("<li>").text("....").inject(i),!0},makeSelection:function(a,b){a.preventDefault(),"null"!==typeOf(b)?(this.getInputElement().value=b.get("text"),this.element.value=b.getProperty("data-value"),this.closeMenu(),this.trigger("selection",[this,this.element.value]),this.element.trigger("change",jQuery.Event("change"),700),this.element.trigger("blur",jQuery.Event("blur"),700),Fabrik.trigger("fabrik.autocomplete.selected",[this,this.element.value])):Fabrik.trigger("fabrik.autocomplete.notselected",[this,this.element.value])},closeMenu:function(){this.shown&&(this.shown=!1,this.menu.hide(),this.selected=-1,document.removeEvent("click",function(a){this.doTestMenuClose(a)}.bind(this)))},openMenu:function(){var a=this;this.shown||this.isMinTriggerlength()&&(this.menu.show(),this.shown=!0,$(document).on("click",function(b){a.doTestMenuClose(b)}),this.selected=0,this.highlight())},isMinTriggerlength:function(){var a=this.getInputElement().get("value");return a.length>=this.options.minTriggerChars},doTestMenuClose:function(){this.mouseinsde||this.closeMenu()},getListMax:function(){return"null"===typeOf(this.data)?0:this.data.length>this.options.max?this.options.max:this.data.length},doWatchKeys:function(a){if(document.activeElement===this.getInputElement()){var b,c,d=this.getListMax();if(this.shown)if(this.isMinTriggerlength())switch(("enter"===a.key||"tab"===a.key)&&$(window).trigger("blur"),a.code){case 40:this.shown||this.openMenu(),this.selected+1<=d&&this.selected++,this.highlight(),a.stopPropagation();break;case 38:this.selected-1>=-1&&(this.selected--,this.highlight()),a.stopPropagation();break;case 13:case 9:a.stopPropagation(),b=this.getSelected(),b&&(c=jQuery.Event("click"),this.makeSelection(c,b),this.closeMenu());break;case 27:a.stopPropagation(),this.closeMenu()}else a.stopPropagation(),this.closeMenu();else 13===parseInt(a.code,10)&&a.stopPropagation(),40===parseInt(a.code,10)&&this.openMenu()}},getSelected:function(){var a=this.menu.find("li"),b=a.filter(function(a,b){return b===this.selected}.bind(this));return"element"===typeOf(b[0])?b[0].find("a"):a.length>0?a[0].find("a"):!1},highlight:function(){this.matchedResult=!0,self=this,this.menu.find("li").each(function(a){a===self.selected?$(this).addClass("selected").addClass("active"):$(this).removeClass("selected").removeClass("active")})}}),FabCddAutocomplete=my.Class(FbAutocomplete,{search:function(a){var b,c,d=this,e=this.getInputElement().val();if(""===e&&(this.element.value=""),e!==this.searchText&&""!==e){if(c=$("#"+this.options.observerid),0===c.length)return void FabCddAutocomplete.Super.prototype.search.call(this,a);this.options.formRef&&(c=Fabrik.getBlock(this.options.formRef).formElements[this.options.observerid]),b=c.val()+"."+e,this.positionMenu(),this.cache[b]?this.populateMenu(this.cache[b])&&this.openMenu():(this.ajax&&(this.closeMenu(),this.ajax.cancel()),this.ajax=$.ajax({url:this.options.url,data:{value:e,fabrik_cascade_ajax_update:1,v:c.val()}}).always(function(){Fabrik.loader.start(d.getInputElement())}).success(function(a){Fabrik.loader.stop(d.getInputElement()),d.ajax=null,d.completeAjax(a)}).fail(function(a,b){Fabrik.loader.stop(d.getInputElement()),d.ajax=null,fconsole("Fabrik autocomplete: Ajax failure: Code "+a.status+": "+b);var c=Fabrik.getBlock(d.options.formRef).formElements.get(this.element.id);c.setErrorMessage(Joomla.JText._("COM_FABRIK_AUTOCOMPLETE_AJAX_ERROR"),"fabrikError",!0)}).done(function(){Fabrik.loader.stop(d.getInputElement())}))}this.searchText=e}});