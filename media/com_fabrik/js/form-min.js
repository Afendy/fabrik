/*! Fabrik */
var FbForm=my.Class({options:{rowid:"",admin:!1,ajax:!1,primaryKey:null,error:"",submitOnEnter:!1,updatedMsg:"Form saved",pages:[],start_page:0,ajaxValidation:!1,showLoader:!1,customJsAction:"",plugins:[],ajaxmethod:"post",inlineMessage:!0,print:!1,images:{alert:"",action_check:"",ajax_loader:""}},constructor:function(a,b){"undefined"==typeof b.rowid&&(b.rowid=""),this.id=a,this.result=!0,this.options=$.extend(this.options,b),this.plugins=this.options.plugins,this.subGroups={},this.currentPage=this.options.start_page,this.formElements={},this.elements=this.formElements,this.duplicatedGroups={},this.fx={},this.fx.elements=[],this.fx.validations={},this.setUpAll(),function(){this.duplicateGroupsToMin()}.bind(this).delay(1e3),this.events={},this.submitBroker=new FbFormSubmit,Fabrik.trigger("fabrik.form.loaded",[this])},setUpAll:function(){var a=this;this.setUp(),this.winScroller=new Fx.Scroll(window),this.form.length>0&&((this.options.ajax||this.options.submitOnEnter===!1)&&this.stopEnterSubmitting(),this.watchAddOptions()),jQuery.each(this.options.hiddenGroup,function(b,c){if(c===!0&&$("#group"+b).length>0){var d=$("#group"+b).find(".fabrikSubGroup");a.subGroups[b]=d.cloneWithIds(),a.hideLastGroup(b,d)}}),this.repeatGroupMarkers={},this.form&&(this.form.find(".fabrikGroup").each(function(){var b=this.id.replace("group",""),c=$(this).find(".fabrikSubGroup").length;1===c&&"none"===$(this).find(".fabrikSubGroupElements").css("display")&&(c=0),a.repeatGroupMarkers[b]=c}),this.watchGoBackButton()),this.watchPrintButton(),this.watchPdfButton()},watchPrintButton:function(){var a=this;$("a[data-fabrik-print]").on("click",function(b){if(b.stopPropagation(),a.options.print)window.print();else{var c="index.php?option=com_"+Fabrik["package"]+"&view=details&tmpl=component&formid="+a.id+"&listid="+a.options.listid+"&rowid="+a.options.rowid+"&iframe=1&print=1",d="status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,resizable=yes,width=400,height=350,directories=no,location=no;";window.open(c,"win2",d)}})},watchPdfButton:function(){var a=this;$('*[data-role="open-form-pdf"]').on("click",function(b){b.stopPropagation(),window.location="index.php?option=com_"+Fabrik["package"]+"&view=details&formid="+a.id+"&rowid="+a.options.rowid+"&format=pdf"})},watchGoBackButton:function(){var a=this.options.fabrik_window_id;if(this.options.ajax){var b=this._getButton("Goback");if(0===b.length)return;b.on("click",function(b){b.stopPropagation(),Fabrik.Windows[a]?Fabrik.Windows[a].close():window.history.back()})}},watchAddOptions:function(){this.fx.addOptions=[],this.getForm().find(".addoption").each(function(){var a=$(this),b=a.closest(".fabrikElementContainer").find(".toggle-addoption");a.slideUp(500),b.on("click",function(b){b.preventDefault(),b.stopPropagation(),a.slideToggle()})})},setUp:function(){this.form=this.getForm(),this.watchGroupButtons(),this.watchSubmit(),this.createPages(),this.watchClearSession()},getForm:function(){return void 0===this.form&&(this.form=$("#"+this.getBlock())),this.form},getBlock:function(){return void 0===this.block&&(this.block=this.options.editable===!0?"form_"+this.id:"details_"+this.id,""!==this.options.rowid&&(this.block+="_"+this.options.rowid)),this.block},addElementFX:function(a,b){var c,d,e;if(a=a.replace("fabrik_trigger_",""),"group_"===a.slice(0,6)){if(a=a.slice(6,a.length),d=a,c=$("#"+a),0===c.length)return fconsole('Fabrik form::addElementFX: Group "'+a+'" does not exist.'),!1}else{if("element_"!==a.slice(0,8))return fconsole("Fabrik form::addElementFX: Not an element or group: "+a),!1;if(a=a.slice(8,a.length),d="element"+a,c=$("#"+a),!c)return fconsole('Fabrik form::addElementFX: Element "'+a+'" does not exist.'),!1;if(c=c.closest(".fabrikElementContainer"),!c)return fconsole('Fabrik form::addElementFX: Element "'+a+'.fabrikElementContainer" does not exist.'),!1}if(c.length>0){var f=c.prop("tagName");"LI"===f||"TD"===f?(e=$("<div />").css({width:"100%"}).append(c.getChildren()),c.empty(),e.inject(c)):e=c;var g={duration:800,transition:Fx.Transitions.Sine.easeInOut};return"null"===typeOf(this.fx.elements[d])&&(this.fx.elements[d]={}),this.fx.elements[d].css=new Fx.Morph(e,g),"null"===typeOf(e)||"slide in"!==b&&"slide out"!==b&&"slide toggle"!==b||(this.fx.elements[d].slide=new Fx.Slide(e,g)),this.fx.elements[d]}return!1},_createFxKey:function(a){var b;return a=a.replace("fabrik_trigger_",""),"group_"===a.slice(0,6)?(a=a.slice(6,a.length),"group_"===a.slice(0,6)&&(a=a.slice(6,a.length)),b=a):(a=a.slice(8,a.length),b="element"+a),b},_groupFx:function(a){return"group_"===a.replace("fabrik_trigger_","").slice(0,6)},doElementFX:function(a,b,c){var d,e,f,g,h=this.formElements[a.replace("fabrik_trigger_element_","")],i=!0;if(h&&(i=h.options.inRepeatGroup),c&&i&&c.options.inRepeatGroup){var j=a.split("_");j[j.length-1]=c.options.repeatCounter,a=j.join("_")}if(d=this._createFxKey(a),e=this._groupFx(a),f=this.fx.elements[d],f||(f=this.addElementFX("element_"+a,b))){switch(g=e||f.css.element.hasClass("fabrikElementContainer")?f.css.element:f.css.element.closest(".fabrikElementContainer"),"TD"===g.prop("tagName")&&(g=g.getChildren()[0]),b){case"show":g.fade("show").removeClass("fabrikHide"),e&&$("#"+a).find(".fabrikinput").css("opacity","1");break;case"hide":g.fade("hide").addClass("fabrikHide");break;case"fadein":g.removeClass("fabrikHide"),"fadein"!==f.css.lastMethod&&(f.css.element.show(),f.css.start({opacity:[0,1]}));break;case"fadeout":"fadeout"!==f.css.lastMethod&&f.css.start({opacity:[1,0]}).chain(function(){f.css.element.hide(),g.addClass("fabrikHide")});break;case"slide in":f.slide.slideIn();break;case"slide out":f.slide.slideOut(),g.removeClass("fabrikHide");break;case"slide toggle":f.slide.toggle();break;case"clear":this.formElements[a].clear()}f.lastMethod=b,Fabrik.trigger("fabrik.form.doelementfx",[this])}},watchClearSession:function(){var a=this;this.form.find(".clearSession").on("click",function(b){b.stopPropagation(),a.form.find("input[name=task]").val("removeSession"),a.clearForm(),a.form.submit()})},createPages:function(){var a,b,c,d,e=this;this.isMultiPage()&&(jQuery.each(this.options.pages,function(a,e){if(b=$(document.createElement("div")),b.attr({"class":"page",id:"page_"+a}),c=$("#group"+e[0]),c.length>0){if(d=c.closest("div"),0===d.length||d.hasClass("tab-pane"))return;b.inject(c,"before"),e.each(function(a){b.append($("#group"+a))})}}),a=this._getButton("Submit"),a&&""===this.options.rowid&&(a.prop("disabled","disabled"),a.css("opacity",.5)),this.form.find(".fabrikPagePrevious").length>0&&(this.form.find(".fabrikPagePrevious").prop("disabled","disabled"),this.form.find(".fabrikPagePrevious").on("click",function(a){e._doPageNav(a,-1)})),"null"!==typeOf(document.find(".fabrikPagePrevious"))&&this.form.find(".fabrikPageNext").on("click",function(a){e._doPageNav(a,1)}),this.setPageButtons(),this.hideOtherPages())},isMultiPage:function(){return Object.keys(this.options.pages).length>1},_doPageNav:function(a,b){var c,d=this;if(this.options.editable){this.form.find(".fabrikMainError").addClass("fabrikHide"),$(".tool-tip").css("top",0),c="index.php?option=com_fabrik&format=raw&task=form.ajax_validate&form_id="+this.id,Fabrik.loader.start(this.getBlock(),Joomla.JText._("COM_FABRIK_VALIDATING"));var e=this.getFormData();e.task="form.ajax_validate",e.fabrik_ajax="1",e.format="raw",e=this._prepareRepeatsForAjax(e);{$.ajax({url:c,method:this.options.ajaxmethod,data:e}).done(function(a){Fabrik.loader.stop(d.getBlock()),a=JSON.decode(a),(-1===b||d._showGroupError(a,e)===!1)&&(d.changePage(b),d.saveGroupsToDb()),new Fx.Scroll(window).toElement(this.form)})}}else this.changePage(b);a.stopPropagation()},saveGroupsToDb:function(){var a,b=this,c=this.form.find("input[name=format]").value,d=this.form.find("input[name=task]").value,e="index.php?option=com_fabrik&format=raw&page="+this.currentPage;if(0!==this.options.multipage_save){if(Fabrik.trigger("fabrik.form.groups.save.start",[this]),this.result===!1)return void(this.result=!0);this.form.find("input[name=format]").val("raw"),this.form.find("input[name=task]").val("form.savepage"),Fabrik.loader.start(this.getBlock(),"saving page"),a=this.getFormData(),a.fabrik_ajax=1,new $.ajax({url:e,method:this.options.ajaxmethod,data:a}).done(function(a){return Fabrik.trigger("fabrik.form.groups.save.completed",[this]),b.result===!1?void(b.result=!0):(b.form.find("input[name=format]").val(c),b.form.find("input[name=task]").val(d),b.options.ajax&&Fabrik.trigger("fabrik.form.groups.save.end",[this,a]),void Fabrik.loader.stop(b.getBlock()))})}},changePage:function(a){return this.changePageDir=a,Fabrik.trigger("fabrik.form.page.change",[this,a]),this.result===!1?void(this.result=!0):(this.currentPage=parseInt(this.currentPage,10),this.currentPage+a>=0&&this.currentPage+a<Object.keys(this.options.pages).length&&(this.currentPage=this.currentPage+a,this.pageGroupsVisible()||this.changePage(a)),this.setPageButtons(),$("#page_"+this.currentPage).css("display",""),this.hideOtherPages(),Fabrik.trigger("fabrik.form.page.chage.end",[this,a]),Fabrik.trigger("fabrik.form.page.change.end",[this,a]),this.result===!1?void(this.result=!0):void 0)},pageGroupsVisible:function(){var a=!1;return this.options.pages.get(this.currentPage).each(function(b){var c=$("#group"+b);c.length>0&&"none"!==c.css("display")&&(a=!0)}),a},hideOtherPages:function(){var a,b=parseInt(this.currentPage,10);this.options.pages.each(function(c,d){parseInt(d,10)!==b&&(a=$("#page_"+d),a.length>0&&a.hide())})},setPageButtons:function(){var a=this._getButton("Submit"),b=this.form.find(".fabrikPagePrevious"),c=this.form.find(".fabrikPageNext");c.length>0&&(this.currentPage===Object.keys(this.options.pages).length-1?("null"!==typeOf(a)&&(a.prop("disabled",""),a.css("opacity",1)),c.prop("disabled","disabled"),c.css("opacity",.5)):(a.length>0&&(""===this.options.rowid||"0"===this.options.rowid.toString())&&(a.prop("disabled","disabled"),a.css("opacity",.5)),c.prop("disabled",""),c.css("opacity",1))),b.length>0&&(0===this.currentPage?(b.prop("disabled","disabled"),b.css("opacity",.5)):(b.prop("disabled",""),b.css("opacity",1)))},destroyElements:function(){jQuery.each(this.formElements,function(){$(this).destroy()})},addElements:function(a){var b,c=[],d=this;for($.each(a,function(a,b){b.each(function(b){if($.isArray(b)){if(0===$("#"+b[1]).length)return void fconsole('Fabrik form::addElements: Cannot add element "'+b[1]+'" because it does not exist in HTML.');var e=new window[b[0]](b[1],b[2]);c.push(d.addElement(e,b[1],a))}else if("object"==typeof b){if(0===$("#"+b.options.element).length)return void fconsole('Fabrik form::addElements: Cannot add element "'+b.options.element+'" because it does not exist in HTML.');c.push(d.addElement(b,b.options.element,a))}else fconsole(void 0===b?"Fabrik form::addElements: Cannot add unknown element: "+b:"Fabrik form::addElements: Cannot add null element.")})}),b=0;b<c.length;b++)if("null"!==typeOf(c[b]))try{c[b].attachedToForm()}catch(e){fconsole(c[b].options.element+" attach to form:"+e)}Fabrik.trigger("fabrik.form.elements.added",[this])},addElement:function(a,b,c){b=a.getFormElementsKey(b),b=b.replace("[]","");var d="_ro"===b.substring(b.length-3,b.length);return a.form=this,a.groupid=c,this.formElements[b]=a,Fabrik.trigger("fabrik.form.element.added",[this,b,a]),d&&(b=b.substr(0,b.length-3),this.formElements[b]=a),this.submitBroker.addElement(b,a),a},dispatchEvent:function(a,b,c,d){"string"==typeof d&&(d=Encoder.htmlDecode(d));var e=this.formElements[b];if(!e){$.each(this.formElements,function(a){b===a.baseElementId&&(e=a)})}e?""!==d?e.addNewEvent(c,d):Fabrik.debug&&fconsole("Fabrik form::dispatchEvent: Javascript empty for "+c+" event on: "+b):fconsole("Fabrik form::dispatchEvent: Cannot find element to add "+c+" event to: "+b)},action:function(a,b){this.formElements[b];Browser.exec("oEl."+a+"()")},triggerEvents:function(a){this.formElements[a].fireEvents(arguments[1])},watchValidation:function(a,b){if(this.options.ajaxValidation!==!1){var c=$("#"+a),d=this;return 0===c.length?void fconsole("Fabrik form::watchValidation: Could not add "+b+' event because element "'+a+'" does not exist.'):c.hasClass("fabrikSubElementContainer")?void c.find(".fabrikinput").each(function(){$(this).on(b,function(a){d.doElementValidation(a,!0)})}):void c.on(b,function(a){d.doElementValidation(a,!1)})}},doElementValidation:function(a,b,c){var d,e=this;if(this.options.ajaxValidation!==!1&&(c="null"===typeOf(c)?"_time":c,"event"===typeOf(a)||"object"===typeOf(a)||"domevent"===typeOf(a)?(d=a.target.id,b===!0&&(d=$(a.target).closest(".fabrikSubElementContainer").id)):d=a,0!==$("#"+d).length)){$("#"+d).prop("readonly")===!0||"readonly"===$("#"+d).prop("readonly");var f=this.formElements[d];if(f||(d=d.replace(c,""),f=this.formElements[d])){if(Fabrik.trigger("fabrik.form.element.validation.start",[this,f,a]),this.result===!1)return void(this.result=!0);f.setErrorMessage(Joomla.JText._("COM_FABRIK_VALIDATING"),"fabrikValidating");var g=this.getFormData();g.task="form.ajax_validate",g.fabrik_ajax="1",g.format="raw",g=this._prepareRepeatsForAjax(g);var h=d;f.origId&&(h=f.origId+"_0"),f.options.repeatCounter=f.options.repeatCounter?f.options.repeatCounter:0;var i="index.php?option=com_fabrik&form_id="+this.id;$.ajax({url:i,method:this.options.ajaxmethod,data:g}).done(function(a){e._completeValidaton(a,d,h)})}}},_completeValidaton:function(a,b,c){if(a=JSON.decode(a),null===a)return this._showElementError(["Oups"],b),void(this.result=!0);if($.each(this.formElements,function(a,b){b.afterAjaxValidation()}),Fabrik.trigger("fabrik.form.element.validation.complete",[this,a,b,c]),this.result===!1)return void(this.result=!0);var d=this.formElements[b];"null"!==typeOf(a.modified[c])&&d.update(a.modified[c]),"null"!==typeOf(a.errors[c])?this._showElementError(a.errors[c][d.options.repeatCounter],b):this._showElementError([],b)},_prepareRepeatsForAjax:function(a){return this.getForm(),$.each(this.form.find("input[name^=fabrik_repeat_group]"),function(){if(this.id.test(/fabrik_repeat_group_\d+_counter/)){var b=this.name.match(/\[(.*)\]/)[1];a["fabrik_repeat_group["+b+"]"]=$(this).val()}}),a},_showGroupError:function(a,b){var c,d=this,e=Array.from(this.options.pages[parseInt(this.currentPage,10)]),f=!1;return jQuery.each(b,function(b){if(b=b.replace(/\[(.*)\]/,"").replace(/%5B(.*)%5D/,""),void 0!==d.formElements[b]){var g=d.formElements[b];if(e.contains(parseInt(g.groupid,10))){if(a.errors[b]){var h="";"null"!==typeOf(a.errors[b])&&(h=a.errors[b].flatten().join("<br />")),""!==h?(c=d._showElementError(a.errors[b],b),f===!1&&(f=c)):g.setErrorMessage("","")}a.modified[b]&&g&&g.update(a.modified[b])}}}),f},_showElementError:function(a,b){var c="";"null"!==typeOf(a)&&(c=a.flatten().join("<br />"));var d=""===c?"fabrikSuccess":"fabrikError";return""===c&&(c=Joomla.JText._("COM_FABRIK_SUCCESS")),c="<span> "+c+"</span>",this.formElements[b].setErrorMessage(c,d),"fabrikSuccess"===d?!1:!0},updateMainError:function(){var a,b=this.form.find(".fabrikMainError");b.html(this.options.error),a=this.form.find(".fabrikError").filter(function(a){return!a.hasClass("fabrikMainError")}),a.length>0&&b.hasClass("fabrikHide")&&this.showMainError(this.options.error),0===a.length&&this.hideMainError()},hideMainError:function(){var a=this.form.find(".fabrikMainError");new Fx.Tween(a,{property:"opacity",duration:500,onComplete:function(){a.addClass("fabrikHide")}}).start(1,0)},showMainError:function(a){if(!this.options.ajaxValidation){var b=this.form.find(".fabrikMainError");b.html(a),b.removeClass("fabrikHide"),myfx=new Fx.Tween(b,{property:"opacity",duration:500}).start(0,1)}},_getButton:function(a){if(this.getForm()){var b=this.form.find("input[type=button][name="+a+"]");return b||(b=this.form.find("input[type=submit][name="+a+"]")),b||(b=this.form.find("button[type=button][name="+a+"]")),b||(b=this.form.find("button[type=submit][name="+a+"]")),b}},watchSubmit:function(){var a=this._getButton("Submit"),b=this;if(0!==a.length){var c=this._getButton("apply"),d=this._getButton("delete"),e=this._getButton("Copy");d&&d.on("click",function(a){if(!window.confirm(Joomla.JText._("COM_FABRIK_CONFIRM_DELETE_1")))return!1;var c=Fabrik.trigger("fabrik.form.delete",[b,b.options.rowid]).eventResults;return"null"!==typeOf(c)&&0!==c.length&&c.contains(!1)?(a.stopPropagation(),!1):(this.form.find("input[name=task]").val("form.delete"),void this.doSubmit(a,d))});var f=this.form.find("button[type=submit]").combine([c,a,e]);f.each(function(){var a=$(this);a.on("click",function(c){b.doSubmit(c,a)})}),this.form.on("submit",function(a){b.doSubmit(a)})}},doSubmit:function(a,b){var c=this;return this.submitBroker.enabled()?(a.stopPropagation(),!1):(this.submitBroker.submit(function(){if(c.options.showLoader&&Fabrik.loader.start(c.getBlock(),Joomla.JText._("COM_FABRIK_LOADING")),Fabrik.trigger("fabrik.form.submit.start",[c,a,b]),c.result===!1)return c.result=!0,a.stopPropagation(),Fabrik.loader.stop(c.getBlock()),void c.updateMainError();if(Object.keys(c.options.pages).length>1){var d=$(document.createElement("input")).attr({name:"currentPage",value:parseInt(c.currentPage,10),type:"hidden"});c.form.append(d)}if(c.options.ajax&&c.form){c.options.showLoader||Fabrik.loader.start(c.getBlock(),Joomla.JText._("COM_FABRIK_LOADING"));var e=c.getFormData();e=c._prepareRepeatsForAjax(e),e[b.name]=b.value,"Copy"===b.name&&(e.Copy=1,a.stopPropagation()),e.fabrik_ajax="1",e.format="raw",$.getJSON({url:this.form.action,data:e,method:this.options.ajaxmethod}).fail(function(){Fabrik.loader.stop(this.getBlock(),"Ajax failure")}).done(function(d){var e=!1;if(void 0!==d.errors&&jQuery.each(d.errors,function(b,d){if("undefined"!=typeof c.formElements[b]&&d.flatten().length>0)if(e=!0,c.formElements[b].options.inRepeatGroup){for(a=0;a<d.length;a++)if(d[a].flatten().length>0){var f=b.replace(/(_\d+)$/,"_"+a);c._showElementError(d[a],f)}}else c._showElementError(d,b)}),c.updateMainError(),e===!1){var f=!1;""===c.options.rowid&&"apply"!==b.name&&(f=!0),Fabrik.loader.stop(c.getBlock());var g="null"!==typeOf(d.msg)&&void 0!==d.msg&&""!==d.msg?d.msg:Joomla.JText._("COM_FABRIK_FORM_SAVED");if(d.baseRedirect!==!0)if(f=d.reset_form,void 0!==d.url)if("popup"===d.redirect_how){var h=d.width?d.width:400,i=d.height?d.height:400,j=d.x_offset?d.x_offset:0,k=d.y_offset?d.y_offset:0,l=d.title?d.title:"";Fabrik.getWindow({id:"redirect",type:"redirect",contentURL:d.url,caller:c.getBlock(),height:i,width:h,offset_x:j,offset_y:k,title:l})}else"samepage"===d.redirect_how?window.open(d.url,"_self"):"newpage"===d.redirect_how&&window.open(d.url,"_blank");else d.suppressMsg||window.alert(g);else f=void 0!==d.reset_form?d.reset_form:f,d.suppressMsg||window.alert(g);Fabrik.trigger("fabrik.form.submitted",[this,d]),"apply"!==b.name&&(f&&c.clearForm(),Fabrik.Windows[c.options.fabrik_window_id]&&Fabrik.Windows[c.options.fabrik_window_id].close())}else Fabrik.trigger("fabrik.form.submit.failed",[c,d]),Fabrik.loader.stop(c.getBlock(),Joomla.JText._("COM_FABRIK_VALIDATION_ERROR"))})}Fabrik.trigger("fabrik.form.submit.end",[c]),c.result===!1?(c.result=!0,a.stopPropagation(),c.updateMainError()):c.options.ajax?(a.stopPropagation(),Fabrik.trigger("fabrik.form.ajax.submit.end",[c])):b.length>0?($(document.createElement("input")).attr({type:"hidden",name:b.name,value:b.value}).inject(c.form),c.form.submit()):a.stopPropagation()}),void a.stopPropagation())},getFormData:function(a){a="null"!==typeOf(a)?a:!0,a&&jQuery(this.formElements,function(a,b){b.onsubmit()}),this.getForm();var b=this.form.toQueryString(),c={};b=b.split("&");var d={};b.each(function(a){a=a.split("=");var b=a[0];b=decodeURI(b),"[]"===b.substring(b.length-2)&&(b=b.substring(0,b.length-2),d[b]=d.hasOwnProperty(b)?d[b]+1:0,b=b+"["+d[b]+"]"),c[b]=a[1]});Object.keys(this.formElements);return jQuery.each(this.formElements,function(a,b){if("fabrikfileupload"===b.plugin&&(c[a]=b.val()),"null"===typeOf(c[a])){var d=!1;jQuery.each(c,function(b){b=unescape(b),b=b.replace(/\[(.*)\]/,""),b===a&&(d=!0)}.bind(this)),d||(c[a]="")}}.bind(this)),c},getFormElementData:function(){var a={};return jQuery.each(this.formElements,function(b,c){c.element&&(a[b]=c.getValue(),a[b+"_raw"]=a[b])}),a},watchGroupButtons:function(){var a=this;this.form.on("click",".deleteGroup",function(b){b.preventDefault();var c=$(this).closest(".fabrikGroup"),d=$(this).closest(".fabrikSubGroup");a.deleteGroup(b,c,d)}),this.form.on("click:relay(.addGroup)",function(b){b.preventDefault(),a.duplicateGroup(b)}),this.form.on("click",".fabrikSubGroup",function(){var a=$(this).find(".fabrikGroupRepeater");a.length>0&&($(this).on("mouseenter",function(){a.fade(1)}),$(this).on("mouseleave",function(){a.fade(.2)}))})},duplicateGroupsToMin:function(){var a=this;this.form&&(Fabrik.trigger("fabrik.form.group.duplicate.min",[this]),$.each(this.options.group_repeats,function(b,c){if(void 0!==a.options.minRepeat[c]&&1===parseInt(b,10)){var d,e,f,g,h,i,j,k=a.form.find("#fabrik_repeat_group_"+c+"_counter");if(0!==k.length){d=e=parseInt(k.val(),10),1===d&&(i=a.form.find("#"+a.options.group_pk_ids[c]+"_0"),""===i.val()&&(e=0));var l=parseInt(a.options.minRepeat[c],10);if(0===l&&0===e){g=a.form.find("#group"+c+" .deleteGroup"),j=0!==g.length?jQuery.Event("click"):!1;var m=a.form.find("#group"+c),n=m.find(".fabrikSubGroup");a.deleteGroup(j,m,n)}else if(l>d&&(f=a.form.find("#group"+c+" .addGroup"),f.length>0)){var o=jQuery.Event("click");for(h=d;l>h;h++)a.duplicateGroup(o)}}}}))},deleteGroup:function(a,b,c){var d=this;if(Fabrik.trigger("fabrik.form.group.delete",[this,a,b]),this.result===!1)return void(this.result=!0);a&&a.stopPropagation();var e=0;b.find(".deleteGroup").each(function(b,c){($(this).find("img")===$(a.target)||$(this).find("i")===$(a.target)||$(this)===$(a.target))&&(e=c)});var f=b.id.replace("group",""),g=parseInt($("#fabrik_repeat_group_"+f+"_counter").val(),10);if(g<=this.options.minRepeat[f]&&0!==this.options.minRepeat[f]){if(""!==this.options.minMaxErrMsg[f]){var h=this.options.minMaxErrMsg[f];h=h.replace(/\{min\}/,this.options.minRepeat[f]),h=h.replace(/\{max\}/,this.options.maxRepeat[f]),window.alert(h)}}else if(delete this.duplicatedGroups.i,"0"!==$("#fabrik_repeat_group_"+f+"_counter").val()){var i=b.find(".fabrikSubGroup");if(this.subGroups[f]=c.clone(),i.length<=1)this.hideLastGroup(f,c),Fabrik.trigger("fabrik.form.group.delete.end",[this,a,f,e]);else{var j=c.getPrevious();if(new Fx.Tween(c,{property:"opacity",duration:300,onComplete:function(){i.length>1&&c.remove(),$.each(d.formElements,function(a,b){"null"!==typeOf(b.element)&&0===$("#"+b.element.id).length&&(b.decloned(f),delete d.formElements[a])}),i=b.find(".fabrikSubGroup");var g={};$.each(d.formElements,function(a,b){b.groupid===f&&(g[a]=b.decreaseName(e))}),$.each(g,function(a,b){a!==b&&(d.formElements[b]=d.formElements[a],delete d.formElements[a])}),Fabrik.trigger("fabrik.form.group.delete.end",[d,a,f,e])}}).start(1,0),j){var k=$("#"+window).getScroll().y,l=j.getCoordinates();if(l.top<k){var m=l.top;this.winScroller.start(0,m)}}}var n=parseInt($("#fabrik_repeat_group_"+f+"_counter").val(),10)-1;$("#fabrik_repeat_group_"+f+"_counter").val(n),this.repeatGroupMarkers[f]=this.repeatGroupMarkers[f]-1,this.setRepeatGroupIntro(b,f)}},hideLastGroup:function(a,b){var c=b.find(".fabrikSubGroupElements"),d=$(document.createElement("div")).attr({"class":"fabrikNotice alert"}),e=d.text(Joomla.JText._("COM_FABRIK_NO_REPEAT_GROUP_DATA"));if(0===c.length){c=b;var f=c.find(".addGroup"),g=c.closest("table").find("thead th").find();f.length>0&&f.inject(g)}c.css("display","none"),e.inject(c,"after")},isFirstRepeatSubGroup:function(a){var b=a.find(".fabrikSubGroup");return 1===b.length&&a.find(".fabrikNotice")},getSubGroupToClone:function(a){var b=$("#group"+a),c=b.find(".fabrikSubGroup");c||(c=this.subGroups[a]);var d=null,e=!1;return this.duplicatedGroups.hasOwnProperty(a)&&(e=!0),e?d=c?c.cloneNode(!0):this.duplicatedGroups[a]:(d=c.cloneNode(!0),this.duplicatedGroups[a]=d),d},repeatGetChecked:function(a){var b=[];return a.find(".fabrikinput").each(function(a){"radio"===this.type&&$(this).prop("checked")&&b.push(a)}),b},duplicateGroup:function(a){var b,c,d=this;if(Fabrik.trigger("fabrik.form.group.duplicate",[this,a]),this.result===!1)return void(this.result=!0);a&&a.stopPropagation();var e=$(a.target).closest(".fabrikGroup").id.replace("group",""),f=parseInt(e,10),g=$("#group"+e),h=this.repeatGroupMarkers[e],i=parseInt($("#fabrik_repeat_group_"+e+"_counter").val(),10);if(i>=this.options.maxRepeat[e]&&0!==this.options.maxRepeat[e]){if(""!==this.options.minMaxErrMsg[e]){var j=this.options.minMaxErrMsg[e];j=j.replace(/\{min\}/,this.options.minRepeat[e]),j=j.replace(/\{max\}/,this.options.maxRepeat[e]),window.alert(j)}}else{if($("#fabrik_repeat_group_"+e+"_counter").val(i+1),this.isFirstRepeatSubGroup(g)){var k=g.find(".fabrikSubGroup"),l=k[0].find(".fabrikSubGroupElements");if(0===l.length){g.find(".fabrikNotice").remove(),l=k[0];var m=g.find(".addGroup");m.inject(l.find("td.fabrikGroupRepeater")),l.css("display","")}else k[0].find(".fabrikNotice").remove(),k[0].find(".fabrikSubGroupElements").show();return void(this.repeatGroupMarkers[e]=this.repeatGroupMarkers[e]+1)}var n=this.getSubGroupToClone(e),o=this.repeatGetChecked(g);g.find("table.repeatGroupTable")?g.find("table.repeatGroupTable").appendChild(n):g.appendChild(n),o.each(function(){$(this).prop("checked",!0)}),this.subelementCounter=0;var p=[],q=!1,r=(n.find(".fabrikinput"),null);$.each(this.formElements,function(a,d){var e=!1;b=null;var f=-1;if($.each(function(a){q=d.hasSubElements(),c=$(this).closest(".fabrikSubElementContainer");var g=q&&c?c.id:this.id,i=d.getCloneName();if(g.contains(i)){if(r=$(this),e=!0,q)f++,b=$(this).closest(".fabrikSubElementContainer"),$("#"+g).find("input")&&$(this).cloneEvents($("#"+g).find("input"));else{$(this).cloneEvents(d.element);var j=Array.from(d.element.id.split("_"));j.splice(j.length-1,1,h),this.id=j.join("_");var k=$(this).closest(".fabrikElementContainer").find("label");k.prop("for",a.id)}void 0!==this.name&&(this.name=this.name.replace("[0]","["+h+"]"))}}),e){if(q&&b.length>0){var g=d.options.element.split("_");g.splice(g.length-1,1,h),b.id=g.join("_")}var i=d.unclonableProperties(),j=new CloneObject(d,!0,i);j.container=null,j.options.repeatCounter=h,q&&"null"!==typeOf(b)?(j.element=$("#"+b),j.cloneUpdateIds(b.id),j.options.element=b.id,j._getSubElements()):j.cloneUpdateIds(r.id),p.push(j)}}),p.each(function(a){a.cloned(h);var b=new RegExp(d.options.group_pk_ids[f]);!d.options.group_copy_element_values[f]||d.options.group_copy_element_values[f]&&a.element.name&&a.element.name.test(b)?a.reset():a.resetEvents()});var s={};s[e]=p,this.addElements(s);var t=window.getHeight(),u=$("#"+window).getScroll().y,v=n.getCoordinates();if(v.bottom>u+t){var w=v.bottom-t;this.winScroller.start(0,w)}{new Fx.Tween(n,{property:"opacity",duration:500}).set(0)}n.fade(1),Fabrik.trigger("fabrik.form.group.duplicate.end",[this,a,e,h]),this.setRepeatGroupIntro(g,e),this.repeatGroupMarkers[e]=this.repeatGroupMarkers[e]+1}},setRepeatGroupIntro:function(a,b){var c=this.options.group_repeat_intro[b],d="",e=a.find('*[data-role="group-repeat-intro"]');e.each(function(a){d=c.replace("{i}",a+1),$(this).html(d)})},update:function(a){var b=this;if(Fabrik.trigger("fabrik.form.update",[this,a.data]),this.result===!1)return void(this.result=!0);var c=arguments[1]||!1,d=a.data;if(this.getForm(),this.form){var e=this.form.find("input[name=rowid]");d.rowid&&e.val(d.rowid)}jQuery.each(this.formElements,function(e,f){void 0===d[e]&&"_ro"===e.substring(e.length-3,e.length)&&(e=e.substring(0,e.length-3)),void 0===d[e]?a.id!==b.id||c||f.update(""):f.update(d[e])})},reset:function(){return this.addedGroups.each(function(a){var b=$("#"+a).closest("fabrikGroup"),c=b.prop("id").replace("group",""),d=parseInt($("#fabrik_repeat_group_"+c+"_counter").val(),10)-1;$("#fabrik_repeat_group_"+c+"_counter").val(d),a.remove()}),this.addedGroups=[],Fabrik.trigger("fabrik.form.reset",[this]),this.result===!1?void(this.result=!0):void $.each(this.formElements,function(a,b){b.reset()})},showErrors:function(a){var b,c,d,e=null,f=this.form.find(".fabrikMainError"),g=a.errors;a.id===this.id&&Object.keys(g).length>0&&(f.html(this.options.error),f.removeClass("fabrikHide"),g.each(function(a,f){if(b=$("#"+f+"_error"),b.length>0)for(c=0;c<a.length;c++)for(d=0;d<a[c].length;d++)e=$(document.createElement("div")).text(a[c][d]).inject(b);else fconsole(f+"_error not found (form show errors)")}))},appendInfo:function(a){$.each(this.formElements,function(b,c){c.appendInfo&&c.appendInfo(a,b)})},clearForm:function(){var a=this;this.getForm(),this.form&&($.each(this.formElements,function(b,c){b===this.options.primaryKey&&(a.form.find("input[name=rowid]").value=""),c.update("")}),this.form.find(".fabrikError").empty(),this.form.find(".fabrikError").addClass("fabrikHide"))},stopEnterSubmitting:function(){var a=this,b=this.form.find("input.fabrikinput");b.each(function(c){$(this).on("keypress",function(d){"enter"===d.key&&(d.stopPropagation(),b[c+1]&&b[c+1].focus(),c===b.length-1&&a._getButton("Submit").focus())})})},getSubGroupCounter:function(){}});