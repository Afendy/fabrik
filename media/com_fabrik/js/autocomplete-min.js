var FbAutocomplete=new Class({Implements:[Options,Events],options:{menuclass:"auto-complete-container",classes:{ul:"results",li:"result"},url:"index.php",max:10,onSelection:Class.empty,autoLoadSingleResult:true,minTriggerChars:1,storeMatchedResultsOnly:false},initialize:function(e,t){this.matchedResult=false;this.setOptions(t);e=e.replace("-auto-complete","");this.options.labelelement=typeOf(document.id(e+"-auto-complete"))==="null"?document.getElement(e+"-auto-complete"):document.id(e+"-auto-complete");this.cache={};this.selected=-1;this.mouseinsde=false;document.addEvent("keydown",function(e){this.doWatchKeys(e)}.bind(this));this.element=typeOf(document.id(e))==="null"?document.getElement(e):document.id(e);this.buildMenu();if(!this.getInputElement()){fconsole("autocomplete didn't find input element");return}this.getInputElement().setProperty("autocomplete","off");this.getInputElement().addEvent("keyup",function(e){this.search(e)}.bind(this));this.getInputElement().addEvent("blur",function(e){if(this.options.storeMatchedResultsOnly){if(!this.matchedResult){if(typeof this.data==="undefined"||!(this.data.length===1&&this.options.autoLoadSingleResult)){this.element.value=""}}}}.bind(this))},canSearch:function(e){if(!this.isMinTriggerlength()){return false}if(e.key==="tab"||e.key==="enter"){e.stop();this.closeMenu();return false}return true},defineSearchValue:function(){var e=this.getInputElement().get("value");if(e===""){this.element.value=""}return e},search:function(e){if(!this.canSearch(e)){return}this.matchedResult=false;var t=this.getInputElement().get("value");if(t===""){this.element.value=""}if(t!==this.searchText&&t!==""){if(this.options.storeMatchedResultsOnly===false){this.element.value=t}this.positionMenu();if(this.cache[t]){this.populateMenu(this.cache[t]);this.openMenu()}else{if(this.ajax){this.closeMenu();this.ajax.cancel()}var n={value:t};this.ajax=this.makeAjax(this.options.url,n)}}this.searchText=t},makeAjax:function(e,t){return(new Request({url:e,data:t,onRequest:function(){Fabrik.loader.start(this.getInputElement())}.bind(this),onCancel:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onSuccess:function(e){this.completeAjax(e,t.value)}.bind(this),onComplete:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onFailure:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this),onException:function(){Fabrik.loader.stop(this.getInputElement())}.bind(this)})).send()},completeAjax:function(e,t){Fabrik.loader.stop(this.getInputElement());e=JSON.decode(e);this.cache[t]=e;this.populateMenu(e);this.openMenu()},buildMenu:function(){this.menu=(new Element("div",{"class":this.options.menuclass,styles:{position:"absolute"}})).adopt(new Element("ul",{"class":this.options.classes.ul}));this.menu.inject(document.body);this.menu.addEvent("mouseenter",function(){this.mouseinsde=true}.bind(this));this.menu.addEvent("mouseleave",function(){this.mouseinsde=false}.bind(this))},getInputElement:function(){return this.options.labelelement?this.options.labelelement:this.element},positionMenu:function(){var e=this.getInputElement().getCoordinates();var t=this.getInputElement().getPosition();this.menu.setStyles({left:e.left,top:e.top+e.height-1,width:e.width})},populateMenu:function(e){e.map(function(e,t){e.text=Encoder.htmlDecode(e.text);return e});this.data=e;var t=this.getListMax();var n=this.menu.getElement("ul");n.empty();if(e.length===1&&this.options.autoLoadSingleResult){this.matchedResult=true;this.element.value=e[0].value;this.fireEvent("selection",[this,this.element.value])}for(var r=0;r<t;r++){var i=e[r];var s=(new Element("li",{"data-value":i.value,"class":"unselected "+this.options.classes.li})).set("text",i.text);s.inject(n);s.addEvent("click",function(e){e.stop();this.makeSelection(e.target)}.bind(this))}if(e.length>this.options.max){(new Element("li")).set("text","....").inject(n)}},makeSelection:function(e){if(typeOf(e)!=="null"){this.getInputElement().value=e.get("text");this.element.value=e.getProperty("data-value");this.matchedResult=true;this.closeMenu();this.fireEvent("selection",[this,this.element.value]);this.element.fireEvent("change",new Event.Mock(this.element,"change"),700);Fabrik.fireEvent("fabrik.autocomplete.selected",[this,this.element.value])}else{Fabrik.fireEvent("fabrik.autocomplete.notselected",[this,this.element.value])}},closeMenu:function(){if(this.shown){this.shown=false;this.menu.fade("out");this.selected=-1;document.removeEvent("click",function(e){this.doTestMenuClose(e)}.bind(this))}},openMenu:function(){if(!this.shown){if(this.isMinTriggerlength()){this.shown=true;this.menu.setStyle("visibility","visible").fade("in");document.addEvent("click",function(e){this.doTestMenuClose(e)}.bind(this));this.selected=0;this.highlight()}}},doTestMenuClose:function(){if(!this.mouseinsde){this.closeMenu()}},isMinTriggerlength:function(){var e=this.getInputElement().get("value");return e.length>=this.options.minTriggerChars},getListMax:function(){if(typeOf(this.data)==="null"){return 0}return this.data.length>this.options.max?this.options.max:this.data.length},doWatchKeys:function(e){if(document.activeElement!==this.getInputElement()){return}Fabrik.loader.stop(this.getInputElement());var t=this.getListMax();if(!this.shown){if(e.code.toInt()===13){e.stop()}if(e.code.toInt()===40){this.openMenu()}}else{if(!this.isMinTriggerlength()){e.stop();this.closeMenu()}else{if(e.key==="enter"||e.key==="tab"){window.fireEvent("blur")}switch(e.code){case 40:if(!this.shown){this.openMenu()}if(this.selected+1<t){this.selected++;this.highlight()}e.stop();break;case 38:if(this.selected-1>=-1){this.selected--;this.highlight()}e.stop();break;case 13:case 9:e.stop();this.makeSelection(this.getSelected());break;case 27:e.stop();this.matchedResult=false;this.closeMenu();break}}}},getSelected:function(){var e=this.menu.getElements("li").filter(function(e,t){return t===this.selected}.bind(this));return e[0]},highlight:function(){this.matchedResult=true;this.menu.getElements("li").each(function(e,t){if(t===this.selected){e.addClass("selected")}else{e.removeClass("selected")}}.bind(this))}});var FabCddAutocomplete=new Class({Extends:FbAutocomplete,search:function(e){if(!this.canSearch(e)){return}var t,n=this.defineSearchValue();if(n!==this.searchText&&n!==""){var r=document.id(this.options.observerid);if(typeOf(r)!=="null"){t=r.get("value")+"."+n}else{this.parent(e);return}this.positionMenu();if(this.cache[t]){this.populateMenu(this.cache[t]);this.openMenu()}else{if(this.ajax){this.closeMenu();this.ajax.cancel()}var i=document.id(this.options.observerid).get("value");if(typeOf(i)==="null"){i=Fabrik.blocks[this.options.formRef].elements.get(this.options.observerid).get("value")}var s={value:n,fabrik_cascade_ajax_update:1,v:i};this.ajax=this.makeAjax(this.options.url,s)}}this.searchText=n}})