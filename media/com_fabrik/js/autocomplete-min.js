/*! Fabrik */
var FbAutocomplete=my.Class({options:{menuclass:"auto-complete-container",classes:{ul:"results",li:"result"},url:"index.php",max:10,onSelection:Class.empty,autoLoadSingleResult:!0,minTriggerChars:1,storeMatchedResultsOnly:!1},initialize:function(a,b){var c=this;this.matchedResult=!1,this.options=$.extend(this.options,b),a=a.replace("-auto-complete","");var d=$("#"+a+"-auto-complete");this.options.labelelement=0===d.length?$(a+"-auto-complete"):d,this.cache={},this.selected=-1,this.mouseinsde=!1,$(document).on("keydown",function(a){c.doWatchKeys(a)});var e=$("#"+a);return this.element=0===e.length?$(a):e,this.buildMenu(),this.getInputElement()?(this.getInputElement().prop("autocomplete","off"),this.getInputElement().on("keyup",function(a){c.search(a)}),void this.getInputElement().on("blur",function(){c.options.storeMatchedResultsOnly&&(c.matchedResult||void 0!==c.data&&1===c.data.length&&c.options.autoLoadSingleResult||(c.element.value=""))})):void fconsole("autocomplete didn't find input element")},canSearch:function(a){return this.isMinTriggerlength()?"tab"===a.key||"enter"===a.key?(a.stop(),this.closeMenu(),!1):!0:!1},defineSearchValue:function(){var a=this.getInputElement().val();return""===a&&(this.element.value=""),a},search:function(a){if(this.canSearch(a)){this.matchedResult=!1;var b=this.getInputElement().val();if(""===b&&(this.element.value=""),b!==this.searchText&&""!==b)if(this.options.storeMatchedResultsOnly===!1&&(this.element.value=b),this.positionMenu(),this.cache[b])this.populateMenu(this.cache[b]),this.openMenu();else{this.ajax&&(this.closeMenu(),this.ajax.cancel());var c={value:b};this.ajax=this.makeAjax(this.options.url,c)}this.searchText=b}},makeAjax:function(a,b){var c=this;return $.ajax({url:a,data:b}).beforeSend(function(){Fabrik.loader.start(c.getInputElement())}).success(function(a){this.completeAjax(a,b.value)}).fail(function(){Fabrik.loader.stop(this.getInputElement())}).done(function(){Fabrik.loader.stop(c.getInputElement())})},completeAjax:function(a,b){Fabrik.loader.stop(this.getInputElement()),a=JSON.decode(a),this.cache[b]=a,this.populateMenu(a),this.openMenu()},buildMenu:function(){var a=this;this.menu=$(document.createElement("div")).attr({"class":this.options.menuclass,styles:{position:"absolute"}}).adopt($(document.createElement("ul")).attr({"class":this.options.classes.ul})),this.menu.inject(document.body),this.menu.on("mouseenter",function(){a.mouseinsde=!0}),this.menu.on("mouseleave",function(){a.mouseinsde=!1})},getInputElement:function(){return this.options.labelelement?this.options.labelelement:this.element},positionMenu:function(){var a=this.getInputElement().getCoordinates();this.menu.setStyles({left:a.left,top:a.top+a.height-1,width:a.width})},populateMenu:function(a){a.map(function(a){return a.text=Encoder.htmlDecode(a.text),a}),this.data=a;var b=this.getListMax(),c=this,d=this.menu.find("ul");d.empty(),1===a.length&&this.options.autoLoadSingleResult&&(this.matchedResult=!0,this.element.value=a[0].value,this.trigger("selection",[this,this.element.value]));for(var e=0;b>e;e++){var f=a[e],g=new Element("li",{"data-value":f.value,"class":"unselected "+this.options.classes.li}).text(f.text);g.inject(d),g.on("click",function(a){a.stop(),c.makeSelection(a.target)})}a.length>this.options.max&&$(document.createElement("li")).text("....").inject(d)},makeSelection:function(a){0!==a.length?(this.getInputElement().val(a.text()),this.element.value=a.data("value"),this.matchedResult=!0,this.closeMenu(),this.trigger("selection",[this,this.element.value]),this.element.trigger("change",jQuery.Event("change"),700),Fabrik.trigger("fabrik.autocomplete.selected",[this,this.element.value])):Fabrik.trigger("fabrik.autocomplete.notselected",[this,this.element.value])},closeMenu:function(){var a=this;this.shown&&(this.shown=!1,this.menu.fade("out"),this.selected=-1,$(document).removeEvent("click",function(b){a.doTestMenuClose(b)}))},openMenu:function(){var a=this;this.shown||this.isMinTriggerlength()&&(this.shown=!0,this.menu.css("visibility","visible").fade("in"),$(document).on("click",function(b){a.doTestMenuClose(b)}),this.selected=0,this.highlight())},doTestMenuClose:function(){this.mouseinsde||this.closeMenu()},isMinTriggerlength:function(){var a=this.getInputElement().val();return a.length>=this.options.minTriggerChars},getListMax:function(){return void 0===this.data?0:this.data.length>this.options.max?this.options.max:this.data.length},doWatchKeys:function(a){if(document.activeElement===this.getInputElement()){Fabrik.loader.stop(this.getInputElement());var b=this.getListMax();if(this.shown)if(this.isMinTriggerlength())switch(("enter"===a.key||"tab"===a.key)&&$(window).trigger("blur"),a.code){case 40:this.shown||this.openMenu(),this.selected+1<b&&(this.selected++,this.highlight()),a.stop();break;case 38:this.selected-1>=-1&&(this.selected--,this.highlight()),a.stop();break;case 13:case 9:a.stop();var c=jQuery.Event("click");this.makeSelection(c);break;case 27:a.stop(),this.matchedResult=!1,this.closeMenu()}else a.stop(),this.closeMenu();else 13===parseInt(a.code,10)&&a.stop(),40===parseInt(a.code,10)&&this.openMenu()}},getSelected:function(){var a=this.menu.find("li").filter(function(a,b){return b===this.selected}.bind(this));return a[0]},highlight:function(){this.matchedResult=!0;var a=this;this.menu.find("li").each(function(b){b===a.selected?$(this).addClass("selected"):$(this).removeClass("selected")}.bind(this))}}),FabCddAutocomplete=my.Class(FbAutocomplete,{Extends:FbAutocomplete,search:function(a){if(this.canSearch(a)){var b,c=this.defineSearchValue();if(c!==this.searchText&&""!==c){var d=$("#"+this.options.observerid);if(0===d.length)return void this.parent(a);if(b=d.val()+"."+c,this.positionMenu(),this.cache[b])this.populateMenu(this.cache[b]),this.openMenu();else{this.ajax&&(this.closeMenu(),this.ajax.cancel());var e=$("#"+this.options.observerid).val();0===e.length&&(e=Fabrik.getBlock(this.options.formRef).elements.get(this.options.observerid).val());var f={value:c,fabrik_cascade_ajax_update:1,v:e};this.ajax=this.makeAjax(this.options.url,f)}}this.searchText=c}}});