/*! Fabrik */
var DateFilter=my.Class({options:{calendarSetup:{eventName:"click",ifFormat:"%Y/%m/%d",daFormat:"%Y/%m/%d",singleClick:!0,align:"Br",range:[1900,2999],showsTime:!1,timeFormat:"24",electric:!0,step:2,cache:!1,showOthers:!1}},initialize:function(a){this.options=$.append(this.options,a),this.cals={};for(var b=0;b<this.options.ids.length;b++)this.makeCalendar(this.options.ids[b],this.options.buttons[b])},makeCalendar:function(a,b){var c=this;if(this.cals[a])return void this.cals[a].show();if(b=$("#"+b),0!==b.length){this.addEventToCalOpts();var d=Object.clone(this.options.calendarSetup);d.inputField=$("#"+a);var e=d.inputField||d.displayArea,f=d.inputField?d.ifFormat:d.daFormat;this.cals[a]=null,e&&(d.date=Date.parseDate(e.value||e.innerHTML,f)),this.cals[a]=new Calendar(d.firstDay,d.date,d.onSelect,d.onClose),this.cals[a].setDateStatusHandler(d.dateStatusFunc),this.cals[a].setDateToolTipHandler(d.dateTooltipFunc),this.cals[a].showsTime=d.showsTime,this.cals[a].time24="24"===d.timeFormat.toString(),this.cals[a].weekNumbers=d.weekNumbers,this.cals[a].showsOtherMonths=d.showOthers,this.cals[a].yearStep=d.step,this.cals[a].setRange(d.range[0],d.range[1]),this.cals[a].params=d,this.cals[a].params.button=b,this.cals[a].getDateText=d.dateText,this.cals[a].setDateFormat(f),this.cals[a].create(),this.cals[a].refresh(),this.cals[a].hide(),b.on("click",function(b){b.stop(),c.cals[a].params.position?c.cal.showAt(c.cals[a].params.position[0],d[a].position[1]):c.cals[a].showAtElement(c.cals[a].params.button||c.cals[a].params.displayArea||c.cals[a].params.inputField,c.cals[a].params.align),c.cals[a].show()}),this.cals[a].params.inputField.on("blur",function(){var b=c.cals[a].params.inputField.value;if(""!==b){var d=Date.parseDate(b,c.cals[a].params.ifFormat);c.cals[a].date=d}});var g=function(){this.cals[a].hide()};return g.delay(100,this),this.cals[a]}},dateSelect:function(){return!1},calSelect:function(a){this.update(a,a.date.format("db")),a.dateClicked&&a.callCloseHandler()},calClose:function(a){a.hide()},update:function(a,b){b&&("string"===typeOf(b)&&(b=Date.parse(b)),a.params.inputField.value=b.format(this.options.calendarSetup.ifFormat))},addEventToCalOpts:function(){this.options.calendarSetup.onSelect=function(a,b){this.calSelect(a,b)}.bind(this),this.options.calendarSetup.dateStatusFunc=function(a){return this.dateSelect(a)}.bind(this),this.options.calendarSetup.onClose=function(a){this.calClose(a)}.bind(this)},onSubmit:function(){jQuery.each(this.cals,function(a,b){""!==b.params.inputField.value&&(b.params.inputField.value=b.date.format("db"))}.bind(this))},onUpdateData:function(){jQuery.each(this.cals,function(a,b){""!==b.params.inputField.value&&this.update(b,b.date)}.bind(this))}});