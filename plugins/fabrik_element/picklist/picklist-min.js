/*! Fabrik */
var FbPicklist=my.Class(FbElement,{constructor:function(a,b){this.plugin="fabrikpicklist",FbPicklist.Super.call(this,a,b),this.options.allowadd===!0&&(this.watchAddToggle(),this.watchAdd()),this.makeSortable()},makeSortable:function(){if(this.options.editable){var a=this.getContainer(),b=a.find(".fromList"),c=a.find(".toList"),d=b.css("background-color"),e=this;this.sortable=new Sortables([b,c],{clone:!0,revert:!0,opacity:.7,hovercolor:"#ffddff",onComplete:function(a){this.setData(),this.showNotices(a),e.fadeOut(b,d),e.fadeOut(c,d)}.bind(this),onSort:function(a,b){this.showNotices(a,b)}.bind(this),onStart:function(){this.drag.on("onEnter",function(a,f){this.lists.contains(f)&&(e.fadeOut(f,this.options.hovercolor),this.lists.contains(this.drag.overed)&&this.drag.overed.on("mouseleave",function(){e.fadeOut(b,d),e.fadeOut(c,d)}.bind(this)))}.bind(this))}});var f=[b.find("li.emptyplicklist"),c.find("li.emptyplicklist")];this.sortable.removeItems(f),this.showNotices()}},fadeOut:function(a,b){var c=new Fx.Tween(a,{wait:!1,duration:600});c.start("background-color",b)},showNotices:function(a){a&&(a=a.closest("ul"));var b,c,d,e=this.getContainer(),f=[e.find(".fromList"),e.find(".toList")];for(d=0;d<f.length;d++){c=f[d],b=c===a[0]||0===a.length?1:2;var g=c.find("li.emptyplicklist"),h=c.find("li");h.length>b?g.hide():g.show()}},setData:function(){var a=this.getContainer(),b=a.find(".toList"),c=b.find("li"),d=c.map(function(a){return a.id.replace(this.options.element+"_value_","")}.bind(this));this.element.value=JSON.encode(d)},watchAdd:function(){var a=this.getContainer(),b=a.find(".toList"),c=a.find("input[type=button]");0!==c.length&&c.on("click",function(c){var d,e=a.find("input[name=addPicklistValue]"),f=a.find("input[name=addPicklistLabel]"),g=f.val();if(d=e.length>0?e.val():g,""===d||""===g)window.alert(Joomla.JText._("PLG_ELEMENT_PICKLIST_ENTER_VALUE_LABEL"));else{var h=$(document.createElement("li")).addClass("picklist").attr({id:this.element.prop("id")+"_value_"+d}).text(g);b.append(h),this.sortable.addItems(h),c.stopPropagation(),f.val(""),this.setData(),this.addNewOption(d,g),this.showNotices()}}.bind(this))},unclonableProperties:function(){return["form","sortable"]},watchAddToggle:function(){var a,b,c=this.getContainer(),d=c.find("div.addoption"),e=c.find(".toggle-addoption");this.mySlider&&(a=d.clone(),b=c.find(".fabrikElement"),d.parent().destroy(),b.append(a),d=c.find("div.addoption"),d.css("margin",0)),$(d).slideUp(500),e.on("click",function(a){a.stopPropagation(),$(d).slideToggle()})},cloned:function(a){delete this.sortable,this.options.allowadd===!0&&(this.watchAddToggle(),this.watchAdd()),this.makeSortable(),FbPicklist.Super.prototype.cloned(this,a)}});