/*! Fabrik */
var FabrikComment=my.Class({options:{formid:0,rowid:0,label:""},constructor:function(a,b){this.element=$("#"+a),0!==this.element.length&&(this.options=$.append(this.options,b),this.fx={},this.fx.toggleForms={},this.spinner=new Spinner("fabrik-comments",{message:"loading"}),this.ajax={},this.watchReply(),this.watchInput())},ajaxComplete:function(a){a=JSON.decode(a);var b=20*a.depth.toInt()+"px",c="comment_"+a.id,d=$(document.createElement("li")).attr({id:c}).css({"margin-left":b}).html(a.content);"li"===this.currentLi.get("tag")?d.inject(this.currentLi,"after"):d.inject(this.currentLi);var e=new Fx.Tween(d,{property:"opacity",duration:5e3});e.set(0),e.start(0,100),this.watchReply(),"null"!==typeOf(a.message)&&alert(a.message.title,a.message.message),this.spinner.hide(),this.watchInput(),this.updateThumbs()},watchInput:function(){var a=this;this.commentData={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"comment",method:"addComment",g:"form",formid:this.options.formid,rowid:this.options.rowid,label:this.options.label},this.element.find(".replyForm").each(function(b){var c=b.find("textarea");c&&(b.find("button.submit").on("click",function(b){a.doInput(b)}),c.on("click",function(b){a.testInput(b)}))})},testInput:function(a){a.target.val()===Joomla.JText._("PLG_FORM_COMMENT_TYPE_A_COMMENT_HERE")&&(a.target.value="")},updateThumbs:function(){this.thumbs.removeEvents(),this.thumbs.addEvents()},doInput:function(a){var b=this;this.spinner.show();var c=$(a.target).closest(".replyForm");if("master-comment-form"===c.prop("id")){var d=this.element.find("ul").find("li");this.currentLi=d.length>0?d.pop():this.element.find("ul")}else this.currentLi=c.closest("li");if("keydown"===a.type&&13!==a.keyCode.toInt())return void this.spinner.hide();var e=c.find("textarea").val();if(a.stop(),""===e)return this.spinner.hide(),void window.alert(Joomla.JText._("PLG_FORM_COMMENT_PLEASE_ENTER_A_COMMENT_BEFORE_POSTING"));var f=c.find("input[name=name]"),g=f.val();if(""===g)return this.spinner.hide(),void window.alert(Joomla.JText._("PLG_FORM_COMMENT_PLEASE_ENTER_A_NAME_BEFORE_POSTING"));this.commentData.name=g;var h=c.find("input[name^=notify]").filter(function(a){return a.checked});this.commentData.notify=h.length>0?h[0].val():"0";var i=c.find("input[name=email]");if(i){var j=i.val();if(""===j)return this.spinner.hide(),void window.alert(Joomla.JText._("PLG_FORM_COMMENT_ENTER_EMAIL_BEFORE_POSTNG"))}var k=c.find("input[name=reply_to]").val();""===k&&(k=0),this.commentData.email=c.find("input[name=email]").val(),this.commentData.renderOrder=c.find("input[name=renderOrder]").val(),this.commentData.rating=c.find("select[name=rating]").val();var l=c.find("input[name^=anonymous]").filter(function(a){return a.checked===!0});this.commentData.anonymous=l[0].val(),this.commentData.reply_to=k,this.commentData.comment=e,$.ajax({url:"index.php",method:"get"}).fail(function(a,c,d){window.alert(c+": "+d),b.spinner.hide()}).success(function(a){b.ajaxComplete(a)}),c.find("textarea").value=""},saveComment:function(a){var b=a.closest(".comment").id.replace("comment-","");$.ajax({url:"",method:"post",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"comment",method:"updateComment",g:"form",formid:this.options.formid,rowid:this.options.rowid,comment:a.get("text"),comment_id:b}})},watchReply:function(){var a,b=this;this.spinner.resize(),this.element.closest(".replybutton").each(function(b){var c;$(this).removeEvents();var d=$(this).parent().parent().getNext();if(0===d.length&&(d=b.closest(".comment").find(".replyForm")),d.length>0){var e=b.closest(".comment").closest("li");window.ie?c=new Fx.Slide(d,"opacity",{duration:5e3}):a.fx.toggleForms.hasOwnProperty(e.id)?c=a.fx.toggleForms[e.id]:(c=new Fx.Slide(d,"opacity",{duration:5e3}),a.fx.toggleForms[e.id]=c),c.hide(),b.on("click",function(a){a.stop(),c.toggle()})}}),this.element.find(".del-comment").each(function(a){a.removeEvents(),a.on("click",function(a){$.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"comment",method:"deleteComment",g:"form",formid:this.options.formid,rowid:this.options.rowid,comment_id:$(a.target).closest(".comment").prop("id").replace("comment-","")}}).done(function(a){b.deleteComplete(a)}),b.updateThumbs(),a.stop()})}),this.options.admin&&this.element.find(".comment-content").each(function(a){a.removeEvents(),a.on("click",function(c){a.inlineEdit({defaultval:"",type:"textarea",onComplete:function(a){b.saveComment(a)}});var d=$(c.target).parent(),e=d.prop("id").replace("comment-","");new $.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"comment",method:"getEmail",commentid:e,g:"form",formid:b.options.formid,rowid:b.options.rowid}}).done(function(a){d.find(".info").dispose(),$(document.createElement("span")).addClass("info").html(a).inject(d)}),c.stop()})})},deleteComplete:function(a){var b=$("#comment_"+a),c=new Fx.Morph(b,{duration:1e3,transition:Fx.Transitions.Quart.easeOut});c.start({opacity:0,height:0}).chain(function(){b.dispose()})}});