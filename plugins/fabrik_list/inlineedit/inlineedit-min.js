/*! Fabrik */
var FbListInlineEdit=my.Class(FbListPlugin,{constructor:function(a){var b=this;return this.parent(a),this.defaults={},this.editors={},this.inedit=!1,this.saving=!1,"null"===typeOf(this.getList().getForm())?!1:(this.listid=this.options.listid,this.setUp(),Fabrik.addEvent("fabrik.list.clearrows",function(){this.cancel()}.bind(this)),Fabrik.addEvent("fabrik.list.inlineedit.stopEditing",function(){this.stopEditing()}.bind(this)),Fabrik.addEvent("fabrik.list.updaterows",function(){this.watchCells()}.bind(this)),Fabrik.addEvent("fabrik.list.ini",function(){var a=this.getList(),b=a.form.toQueryString().toObject();b.format="raw",b.listref=this.options.ref,new Request.JSON({url:"",data:b,onComplete:function(){console.log("complete")},onSuccess:function(b){b=Json.evaluate(b.stripScripts()),a.options.data=b.data}.bind(this),onFailure:function(a){console.log("ajax inline edit failure",a)},onException:function(a,b){console.log("ajax inline edit exception",a,b)}}).send()}.bind(this)),Fabrik.addEvent("fabrik.element.click",function(){1===Object.getLength(this.options.elements)&&this.options.showSave===!1&&this.save(null,this.editing)}.bind(this)),Fabrik.addEvent("fabrik.list.inlineedit.setData",function(){"null"!==typeOf(this.editOpts)&&(jQuery.each(this.editOpts.plugins,function(a,b){var c=Fabrik["inlineedit_"+this.editOpts.elid].elements[b];delete c.element,c.update(this.editData[b]),c.select()}.bind(this)),this.watchControls(this.editCell),this.setFocus(this.editCell))}.bind(this)),void $(window).on("click",function(){!$(this).hasClass("fabrik_element")&&b.td&&(b.td.removeClass(b.options.focusClass),b.td=null)}))},setUp:function(){var a=this;"null"!==typeOf(this.getList().getForm())&&(this.scrollFx=new Fx.Scroll(window,{wait:!1}),this.watchCells(),$(document).on("keydown",function(b){a.checkKey(b)}))},watchCells:function(){var a=!1,b=this;this.getList().getForm().find(".fabrik_element").each(function(c){if(b.canEdit(c)){if(!a&&b.options.loadFirst&&(a=b.edit(null,c),a&&b.select(null,c)),!b.isEditable(c))return;b.setCursor(c),c.removeEvents(),c.on(this.options.editEvent,function(a){b.edit(a,c)}),c.on("click",function(a){b.select(a,c)}),c.on("mouseenter",function(){b.isEditable(c)||c.css("cursor","pointer")}),c.on("mouseleave",function(){c.css("cursor","")})}})},checkKey:function(a){var b,c,d;if("element"===typeOf(this.td))switch(a.code){case 39:if(this.inedit)return;"element"===typeOf(this.td.getNext())&&(a.stop(),this.select(a,this.td.getNext()));break;case 9:if(this.inedit)return void(this.options.tabSave&&("element"===typeOf(this.editing)?this.save(a,this.editing):this.edit(a,this.td)));break;case 37:if(this.inedit)return;"element"===typeOf(this.td.getPrevious())&&(a.stop(),this.select(a,this.td.getPrevious()));break;case 40:if(this.inedit)return;if(c=this.td.parent(),0===c.length)return;d=c.find("td").indexOf(this.td),"element"===typeOf(c.getNext())&&(a.stop(),b=c.getNext().find("td"),this.select(a,b[d]));break;case 38:if(this.inedit)return;if(c=this.td.parent(),0===c.length)return;d=c.find("td").indexOf(this.td),"element"===typeOf(c.getPrevious())&&(a.stop(),b=c.getPrevious().find("td"),this.select(a,b[d]));break;case 27:a.stop(),this.inedit?(this.select(a,this.editing),this.cancel(a)):(this.td.removeClass(this.options.focusClass),this.td=null);break;case 13:if(this.inedit||"element"!==typeOf(this.td))return;if(a.stop(),"element"===typeOf(this.editing)){if(this.editors[this.activeElementId].contains("<textarea"))return;this.save(a,this.editing)}else this.edit(a,this.td)}},select:function(a,b){if(this.isEditable(b)){var c=this.getElementName(b),d=this.options.elements[c];if(typeOf(d)!==!1&&("element"===typeOf(this.td)&&this.td.removeClass(this.options.focusClass),this.td=b,"element"===typeOf(this.td)&&this.td.addClass(this.options.focusClass),"null"!==typeOf(this.td)&&a&&"click"!==a.type&&"mouseover"!==a.type)){var e=this.td.getPosition(),f=e.x-window.getSize().x/2-this.td.getSize().x/2,g=e.y-window.getSize().y/2+this.td.getSize().y/2;this.scrollFx.start(f,g)}}},getElementName:function(a){var b=a.className.trim().split(" ").filter(function(a){return"fabrik_element"!==a&&"fabrik_row"!==a&&!a.contains("hidden")}),c=b[0].replace("fabrik_row___","");return c},setCursor:function(a){var b=this.getElementName(a),c=this,d=this.options.elements[b];"null"!==typeOf(d)&&(a.on("mouseover",function(a){c.isEditable(a.target)&&$(this).css("cursor","pointer")}),a.on("mouseleave",function(a){c.isEditable(a.target)&&$(this).css("cursor","")}))},isEditable:function(a){if(a.hasClass("fabrik_uneditable")||a.hasClass("fabrik_ordercell")||a.hasClass("fabrik_select")||a.hasClass("fabrik_actions"))return!1;var b=this.getRowId(a.closest(".fabrik_row")),c=this.getList().firePlugin("onCanEditRow",b);return c},getPreviousEditable:function(a){for(var b=!1,c=this.getList().getForm().find(".fabrik_element"),d=c.length;d>=0;d--){if(b&&this.canEdit(c[d]))return c[d];c[d]===a&&(b=!0)}return!1},getNextEditable:function(a){var b=!1,c=this.getList().getForm().find(".fabrik_element").filter(function(c){return b&&this.canEdit(c)?(b=!1,!0):(c===a&&(b=!0),!1)}.bind(this));return c.getLast()},canEdit:function(a){if(!this.isEditable(a))return!1;var b=this.getElementName(a),c=this.options.elements[b];return"null"===typeOf(c)?!1:!0},edit:function(e,td){var self=this;if(!this.saving){if(Fabrik.trigger("fabrik.plugin.inlineedit.editing"),this.inedit){if("mouseover"!==this.options.editEvent)return;if(td===this.editing)return;this.select(e,this.editing),this.cancel()}if(!this.canEdit(td))return!1;"null"!==typeOf(e)&&e.stop();var element=this.getElementName(td),rowid=this.getRowId(td),opts=this.options.elements[element];if("null"!==typeOf(opts)){this.inedit=!0,this.editing=td,this.activeElementId=opts.elid,this.defaults[rowid+"."+opts.elid]=td.innerHTML;var data=this.getDataFromTable(td);if("null"===typeOf(this.editors[opts.elid])||"null"===typeOf(Fabrik["inlineedit_"+opts.elid])){Fabrik.loader.start(td.parent());var inline=this.options.showSave?1:0;$.ajax({evalScripts:function(a){self.javascript=a},evalResponse:!1,url:"",data:{element:element,elid:opts.elid,elementid:Object.values(opts.plugins),rowid:rowid,listref:this.options.ref,formid:this.options.formid,listid:this.options.listid,inlinesave:inline,inlinecancel:this.options.showCancel,option:"com_fabrik",task:"form.inlineedit",format:"raw"}}).fail(function(a,b,c){self.saving=!1,self.inedit=!1,Fabrik.loader.stop(td.parent()),window.alert(b+": "+c)}).success(function(a){Fabrik.loader.stop(td.parent()),function(){Browser.exec(self.javascript),Fabrik.tips.attach(".fabrikTip")}.delay(100),td.empty().html(a),self.clearSelection(),a=a+'<script type="text/javascript">'+self.javascript+"</script>",self.editors[opts.elid]=a,self.watchControls(td),self.setFocus(td)})}else{var html=this.editors[opts.elid].stripScripts(function(a){this.javascript=a}.bind(this));td.empty().html(html),eval(this.javascript),this.clearSelection(),Fabrik.tips.attach(".fabrikTip"),this.editOpts=opts,this.editData=data,this.editCell=td}return!0}}},clearSelection:function(){document.selection?document.selection.empty():window.getSelection().removeAllRanges()},getDataFromTable:function(a){var b=this.getList().options.data,c=this.getElementName(a),d=a.closest(".fabrik_row").id,e={};this.vv=[],jQuery.each(b,function(a,b){if("array"===typeOf(b))for(var c=0;c<b.length;c++)b[c].id===d&&this.vv.push(b[c]);else{Array.filter(b,function(a){return a.id===d})}}.bind(this));var f=this.options.elements[c];return this.vv.length>0&&jQuery.each(f.plugins,function(a,b){e[b]=this.vv[0].data[a+"_raw"]}.bind(this)),e},setTableData:function(a,b,c){var d=a.id,e=this.getList().options.data;jQuery.each(e,function(a,e){jQuery.each(e,function(a,e){e.id===d&&(e.data[b+"_raw"]=c,this.currentRow=e)}.bind(this))}.bind(this))},setFocus:function(a){if(!Browser.ie){var b=a.find(".fabrikinput");if("null"!==typeOf(b)){var c=function(){"null"!==typeOf(b)&&b.focus()};c.delay(1e3)}}},watchControls:function(a){var b=this;a.find(".inline-save").removeEvents("click").on("click",function(c){b.save(c,a)}),a.find(".inline-cancel").removeEvents("click").on("click",function(c){b.cancel(c,a)})},save:function(a,b){var c=this,d=this.getElementName(b),e=this.options.elements[d],f=this.editing.closest(".fabrik_row"),g=this.getRowId(f),h={},i={},j={};if(this.editing){if(this.saving=!0,this.inedit=!1,a&&a.stop(),i=Fabrik["inlineedit_"+e.elid],"null"===typeOf(i))return fconsole("issue saving from inline edit: eObj not defined"),this.cancel(a),!1;Fabrik.loader.start(b.parent()),j={option:"com_fabrik",task:"form.process",format:"raw",packageId:1,fabrik_ajax:1,element:d,listref:this.options.ref,elid:e.elid,plugin:e.plugin,rowid:g,listid:this.options.listid,formid:this.options.formid,fabrik_ignorevalidation:1},j.fabrik_ignorevalidation=0,j.join={},jQuery.each(i.elements,function(a,b){b.find();var c=b.getValue(),d=b.options.joinId;this.setTableData(f,b.options.element,c),b.options.isJoin?("object"!==typeOf(j.join[d])&&(j.join[d]={}),j.join[d][b.options.elementName]=c):j[b.options.element]=c}.bind(this)),jQuery.each(this.currentRow.data,function(a,b){"_raw"===a.substr(a.length-4,4)&&(h[a.substr(0,a.length-4)]=b)}),j=Object.append(h,j),j[i.token]=1,j.toValidate=this.options.elements[j.element].plugins,$.ajax({url:"",data:j,evalScripts:!0}).fail(function(a,d){var e=b.find(".inlineedit .fabrikMainError");0===e.length&&(e=$(document.createElement("div")).addClass("fabrikMainError fabrikError alert alert-error"),e.inject(b.find("form"),"top")),c.saving=!1,Fabrik.loader.stop(b.parent()),e.html(d)}).success(function(a){b.empty(),b.empty().html(a),Fabrik.loader.stop(b.parent()),Fabrik.trigger("fabrik.list.updaterows"),c.stopEditing(),c.saving=!1})}},stopEditing:function(){this.editing;this.editing=null,this.inedit=!1},cancel:function(a){a&&a.stop();var b=this.editing.closest(".fabrik_row"),c=this.getRowId(b),d=this.editing;if(d!==!1){var e=this.getElementName(d),f=this.options.elements[e],g=this.defaults[c+"."+f.elid];d.html(g)}this.stopEditing()}});