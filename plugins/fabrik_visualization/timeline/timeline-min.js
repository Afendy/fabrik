/*! Fabrik */
var FbVisTimeline=my.Class({options:{dateFormat:"%c",orientation:"0",urlfilters:[]},constructor:function(json,options){var self=this;this.json=eval(json),this.options=$.extend(this.options,options),this.resizeTimerID=null,this.tl=null;var dateFormat=this.options.dateFormat;Timeline.GregorianDateLabeller.prototype.labelPrecise=function(a){var b=new Date(a.getTime()+6e4*a.getTimezoneOffset());return b.format(dateFormat)},this.eventSource=new Timeline.DefaultEventSource;var theme=Timeline.ClassicTheme.create();theme.event.bubble.width=320,theme.event.bubble.height=520,theme.event.track.height=11.5,theme.event.track.gap=.1,theme.ether.backgroundColors=["#000000","red"],theme.ether.highlightColor="red",Timeline.setDefaultTheme(theme);for(var bandBase={trackGap:.2,width:"70%",intervalUnit:Timeline.DateTime.DAY,intervalPixels:50},bandTracks=[],b=0;b<json.bands.length;b++){var bandClone=Object.clone(bandBase);bandClone.width=json.bands[b].width,bandClone.intervalUnit=json.bands[b].intervalUnit,bandClone.overview=json.bands[b].overview,bandClone.eventSource=this.eventSource,bandClone.theme=theme,bandTracks.push(Timeline.createBandInfo(bandClone))}for(b=1;b<json.bands.length;b++)bandTracks[b].syncWith=0,bandTracks[b].highlight=!0;SimileAjax.History.enabled=!1,this.tl=Timeline.create($("#my-timeline"),bandTracks,this.options.orientation),this.start=0;var data={option:"com_fabrik",format:"raw",task:"ajax_getEvents",view:"visualization",visualizationid:this.options.id,currentList:this.options.currentList,setListRefFromRequest:1,listref:this.options.listRef};data=Object.merge(data,this.options.urlfilters),this.options.admin?data.task="visualization.ajax_getEvents":data.controller="visualization.timeline",this.start=0,this.counter=$(document.createElement("div")).addClass("timelineTotals").inject($("#my-timeline"),"before"),this.counter.text("loading"),this.ajax=new Request.JSON({url:"index.php",data:data,onSuccess:function(a){this.start=this.start+this.options.step,this.counter.text(this.start>=a.fabrik.total?"loaded "+a.fabrik.total:"loading "+this.start+" / "+a.fabrik.total),this.eventSource.loadJSON(a.timeline.events,""),0===a.fabrik.done.toInt()&&(this.ajax.options.data.start=a.fabrik.next,this.ajax.options.data.currentList=a.fabrik.currentList,this.ajax.send())}.bind(this),onFailure:function(a){alert(a.status+": "+a.statusText)}}),Fabrik.addEvent("fabrik.advancedSearch.submit",function(){console.log("cancel ajax"),self.ajax.cancel()}),this.ajax.send(),$(window).on("resize",function(){null===self.resizeTimerID&&(self.resizeTimerID=window.setTimeout(function(){self.resizeTimerID=null,self.tl.layout()},500))}),this.watchDatePicker()},watchDatePicker:function(){var a=$("#timelineDatePicker"),b=this;if(0!==a.length){var c={eventName:"click",ifFormat:this.options.dateFormat,daFormat:this.options.dateFormat,singleClick:!0,align:"Br",range:[1900,2999],showsTime:!1,timeFormat:"24",electric:!0,step:2,cache:!1,showOthers:!1,advanced:!1},d=this.options.dateFormat;c.date=Date.parseDate(a.value||a.innerHTML,d),c.onClose=function(a){a.hide()},c.onSelect=function(){(b.cal.dateClicked||b.cal.hiliteToday)&&(b.cal.callCloseHandler(),a.value=b.cal.date.format(d),b.tl.getBand(0).setCenterVisibleDate(b.cal.date))},c.inputField=a,c.button=$("#timelineDatePicker_cal_img"),c.align="Tl",c.singleClick=!0,this.cal=new Calendar(0,c.date,c.onSelect,c.onClose),this.cal.showsOtherMonths=c.showOthers,this.cal.yearStep=c.step,this.cal.setRange(c.range[0],c.range[1]),this.cal.params=c,this.cal.setDateFormat(d),this.cal.create(),this.cal.refresh(),this.cal.hide(),c.button.on("click",function(){b.cal.showAtElement(c.button),b.cal.show()}),a.on("blur",function(){b.updateFromField()}),a.on("keyup",function(a){"enter"===a.key&&b.updateFromField()})}},updateFromField:function(){var a=$("#timelineDatePicker").val();d=Date.parseDate(a,this.options.dateFormat),this.cal.date=d;var b=new Date(this.cal.date.getTime()-6e4*this.cal.date.getTimezoneOffset());this.tl.getBand(0).scrollToCenter(b)},submit:function(){}});