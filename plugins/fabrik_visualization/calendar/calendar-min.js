/*! Fabrik */
var fabrikCalendar=my.Class({options:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],months:["January","Feburary","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],viewType:"month",first_week_day:0,calendarId:1,tmpl:"default",Itemid:0,colors:{bg:"#F7F7F7",highlight:"#FFFFDF",headingBg:"#C3D9FF",today:"#dddddd",headingColor:"#135CAE",entryColor:"#eeffff"},eventLists:[],listid:0,popwiny:0,timeFormat:"%X",urlfilters:[],url:{add:"index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=getEvents&format=raw",del:"index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=deleteEvent&format=raw"},monthday:{width:90,height:120},restFilterStart:"na",j3:!1,showFullDetails:!1,readonly:!1,readonlyMonth:!1,dateLimits:{min:"",max:""}},constructor:function(a){var b=this;this.firstRun=!0,this.el=$("#"+a),this.SECOND=1e3,this.MINUTE=60*this.SECOND,this.HOUR=60*this.MINUTE,this.DAY=24*this.HOUR,this.WEEK=7*this.DAY,this.date=new Date,this.selectedDate=new Date,this.entries={},this.droppables={month:[],week:[],day:[]},this.fx={},0!==this.el.find(".calendar-message").length&&(this.fx.showMsg=new Fx.Morph(this.el.find(".calendar-message"),{duration:700}),this.fx.showMsg.set({opacity:0})),this.colwidth={},this.windowopts={id:"addeventwin",title:"add/edit event",loadMethod:"xhr",minimizable:!1,evalScripts:!0,width:380,height:320,onContentLoaded:function(a){a.fitToContent()}.bind(this)},Fabrik.addEvent("fabrik.form.submitted",function(){b.updateEvent(),Fabrik.Windows.addeventwin.close()})},deleteEvent:function(a){a=$.extend({visualizationid:this.options.calendarId},a);var b=this;$.ajax({url:this.options.url.del,data:a}).complete(function(a){a=a.stripScripts(!0);var c=JSON.decode(a);b.entries={},b.addEntries(c)})},updateEvent:function(){var a=this;$.ajax({url:this.options.url.add,data:d,evalScripts:!0}).complete(function(b){if(b){var c=b.stripScripts(!0),d=JSON.decode(c);a.addEntries(d),a.showView()}})},removeFormEvents:function(a){jQuery.each(this.entries,function(b,c){"undefined"!=typeof c&&c.formid===a&&delete this.entries[b]}.bind(this))},_makeEventRelDiv:function(a,b,c,d){var e,f,g,h,i,j=this,k=a.label;b.left===b.left?b.left:0,b["margin-left"]===b["margin-left"]?b["margin-left"]:0;var l=""!==a.colour?a.colour:this.options.colors.entryColor;0===b.startMin&&(b.startMin=b.startMin+"0"),0===b.endMin&&(b.endMin=b.endMin+"0");var m=(b.view?b.view:"dayView",{"background-color":this._getColor(l,c),width:b.width,cursor:"pointer","margin-left":b["margin-left"],top:b.top.toInt()+"px",position:"absolute",border:"1px solid #666666","border-right":"0","border-left":"0",overflow:"auto",opacity:.6,padding:"0 4px"});b.height&&(m.height=b.height.toInt()+"px"),b.left&&(m.left=b.left.toInt()+1+"px"),m["max-width"]=b["max-width"]?b["max-width"]-10+"px":"";var n="fabrikEvent_"+a._listid+"_"+a.id;return d&&"monthView"!==b.view&&(n+=d.className.replace(" ","")),"monthView"===b.view&&(m.width-=1),i="",a._canDelete&&(i+=this.options.buttons.del),a._canEdit&&!this.options.readonly&&(i+=this.options.buttons.edit),a._canView&&(i+=this.options.buttons.view),g={start:Date.parse(a.startdate_locale).format(this.options.timeFormat),end:Date.parse(a.enddate_locale).format(this.options.timeFormat)},h=Joomla.JText._("PLG_VISUALIZATION_CALENDAR_EVENT_START_END").substitute(g),""!==i&&(h+='<hr /><div class="btn-group" style="text-align:center;display:block">'+i+"</div>"),f=$(document.createElement("a")).addClass("fabrikEvent label "+a.status).attr({id:n,styles:m,rel:"popover","data-original-title":k+'<button class="close" data-popover="'+n+'">&times;</button>',"data-content":h,"data-placement":"top","data-html":"true","data-trigger":"click"}),this.options.showFullDetails?f.set("data-task","viewCalEvent"):"undefined"!=typeof jQuery&&(jQuery(f).popover(),f.on("click",function(){j.popOver=f}),f.on("dblclick",function(a){a.stopPropagation()})),a.custom?(k=""===k?"click":k,e=$(document.createElement("a")).attr({href:a.link}).on("click",function(a){Fabrik.trigger("fabrik.viz.calendar.event",[a])}).html(k)):e=$(document.createElement("span")).html(k),f.adopt(e),f},doPopupEvent:function(a,b,c){{var d;this.activeHoverEvent}if(this.popWin){this.activeHoverEvent=a.target.hasClass("fabrikEvent")?a.target:a.target.closest(".fabrikEvent"),b._canDelete?this.popWin.find(".popupDelete").show():this.popWin.find(".popupDelete").hide(),b._canEdit?(this.popWin.find(".popupEdit").show(),this.popWin.find(".popupView").hide()):(this.popWin.find(".popupEdit").hide(),this.popWin.find(".popupView").show()),d=this.activeHoverEvent?this.activeHoverEvent.getCoordinates():{top:0,left:0};var e=this.popup.find("div[class=popLabel]");e.empty(),e.text(c),this.activeDay=a.target.parent();var f=(d.top-this.popWin.getSize().y,{opacity:[0,1],top:[d.top+50,d.top-10]});this.inFadeOut=!1,this.popWin.csss({left:d.left+20,top:d.top}),this.fx.showEventActions.cancel().set({opacity:0}).start.delay(500,this.fx.showEventActions,f)}},_getFirstDayInMonthCalendar:function(a){var b,c=new Date;if(c.setTime(a.valueOf()),a.getDay()!==this.options.first_week_day&&(b=a.getDay()-this.options.first_week_day,0>b&&(b=7+b),a.setTime(a.valueOf()-24*b*60*60*1e3)),c.getMonth()===a.getMonth())for(;a.getDate()>1;)a.setTime(a.valueOf()-this.DAY);return a},dateBetweenOrSame:function(a,b){var c=a.isDateBetween(b.startdate,b.enddate);return""!==b.enddate&&c||""===b.enddate&&b.startdate.isSameDay(a)},showMonth:function(){var a,b,c=new Date,d=this;c.setTime(this.date.valueOf()),c.setDate(1),c=this._getFirstDayInMonthCalendar(c);for(var e=this.el.find(".monthView tr"),f=1;f<e.length;f++){var g=e[f].find("td"),h=0;g.each(function(d){d.setProperties({"class":""}),d.addClass(c.getTime()),c.getMonth()!==this.date.getMonth()&&d.addClass("otherMonth"),this.selectedDate.isSameDay(c)&&d.addClass("selectedDay"),d.empty(),d.adopt($(document.createElement("div")).addClass("date").css({"background-color":this._getColor("#E8EEF7",c)}).appendText(c.getDate()));var e=0;this.entries.each(function(a){this.dateBetweenOrSame(c,a)&&e++}.bind(this));var g=0;this.entries.each(function(i){if(this.dateBetweenOrSame(c,i)){var j=d.find(".fabrikEvent").length,k=d.find(".date").getSize().y;a=Math.floor((d.getSize().y-e-k)/e);var l=d.getSize().y*(f-1)+this.el.find(".monthView .dayHeading").getSize().y+k;this.colwidth[".monthView"]=this.colwidth[".monthView"]?this.colwidth[".monthView"]:d.getSize().x,b=this.colwidth[".monthView"],l+=j*a;var m=b*h,n={view:"monthView","max-width":b};n.top=l,window.ie&&(n.left=m),n.startHour=i.startdate.getHours(),n.endHour=i.enddate.getHours(),n.startMin=i.startdate.getMinutes(),n.endMin=i.enddate.getMinutes(),n["margin-left"]=0,d.adopt(this._makeEventRelDiv(i,n,c,d))}g++}.bind(this)),c.setTime(c.getTime()+this.DAY),h++}.bind(this))}$(document).on("mousemove",function(a){var b=($(this),a.client.x),c=a.client.y,e=d.activeArea;if("null"!==typeOf(e)&&"null"!==typeOf(this.activeDay)&&(b<=e.left||b>=e.right||c<=e.top||c>=e.bottom)){if(!d.inFadeOut){var f=d.activeHoverEvent.getCoordinates(),g={opacity:[1,0],top:[f.top-10,f.top+50]};d.fx.showEventActions.cancel().start.delay(500,d.fx.showEventActions,g)}d.activeDay=null}}),this._highLightToday(),this.el.find(".monthDisplay").html(this.options.months[this.date.getMonth()]+" "+this.date.getFullYear())},_makePopUpWin:function(){if(!this.options.readonly){if(null===this.popup){var a=$(document.createElement("div")).addClass("popLabel"),b=$(document.createElement("div")).addClass("popupDelete").html(this.options.buttons);this.popup=$(document.createElement("div")).addClass("popWin").css({position:"absolute"}).adopt([a,b]),this.popup.inject(document.body),this.activeArea=null,this.fx.showEventActions=new Fx.Morph(this.popup,{duration:500,transition:Fx.Transitions.Quad.easeInOut,onCancel:function(){}.bind(this),onComplete:function(){if(this.activeHoverEvent){var a=this.popup.getCoordinates(),b=this.activeHoverEvent.getCoordinates(),c=window.getScrollTop(),d={};d.left=a.left<b.left?a.left:b.left,d.top=a.top<b.top?a.top:b.top,d.top=d.top-c,d.right=a.right>b.right?a.right:b.right,d.bottom=a.bottom>b.bottom?a.bottom:b.bottom,d.bottom=d.bottom-c,this.activeArea=d,this.inFadeOut=!1}}.bind(this)})}return this.popup}},makeDragMonthEntry:function(){},removeWeekEvents:function(){var a,b,c=this.date.getDay(),d=new Date,e={},f=this.el.find(".weekView tr");for(c-=this.options.first_week_day.toInt(),d.setTime(this.date.getTime()-c*this.DAY),a=1;a<f.length;a++){d.setHours(a-1,0,0),1!==a&&d.setTime(d.getTime()-6*this.DAY);var g=f[a].find("td");for(b=1;b<g.length;b++){void 0===e[b-1]&&(e[b-1]=[]);var h=g[b];e[b-1].push(h),1!==b&&d.setTime(d.getTime()+this.DAY),h.addClass("day"),"null"!==typeOf(h.retrieve("calevents"))&&h.retrieve("calevents").each(function(a){a.destroy()}),h.eliminate("calevents"),h.className="",h.addClass("day"),h.addClass(d.getTime()-this.HOUR),this.selectedDate.isSameWeek(d)&&this.selectedDate.isSameDay(d)?h.addClass("selectedDay"):h.removeClass("selectedDay")}}return e},gridSize:function(a){var b,c,d,e,f={},g=1;return this.entries.each(function(g){if(c=new Date(g.startdate_locale),d=new Date(g.enddate_locale),""!==g.enddate&&a.isDateBetween(c,d)||""===d&&c.isSameDay(a))for(e=this._buildEventOpts({entry:g,curdate:a,divclass:".weekView",tdOffset:i}),b=e.startHour;b<=e.endHour;b++)f[b]="null"===typeOf(f[b])?0:f[b]+1}.bind(this)),Object.each(f,function(a){a>g&&(g=a)}),g},showWeek:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=this.date.getDay();for(n-=this.options.first_week_day.toInt(),j=new Date,j.setTime(this.date.getTime()-n*this.DAY),k=new Date,k.setTime(this.date.getTime()-n*this.DAY),l=new Date,l.setTime(this.date.getTime()+(6-n)*this.DAY),a=j.getDate()+" "+this.options.months[j.getMonth()]+" "+j.getFullYear()+" - "+l.getDate()+"  "+this.options.months[l.getMonth()]+" "+l.getFullYear(),this.el.find(".monthDisplay").html(a),f=this.el.find(".weekView tr"),g=f[0].find("th"),i=this.removeWeekEvents(),b=0;b<g.length;b++){g[b].className="dayHeading",g[b].addClass(k.getTime()),e=g[b].css("background-color"),d=this.options.shortDays[k.getDay()]+" "+k.getDate()+"/"+this.options.shortMonths[k.getMonth()],c=$(document.createElement("div")).css({"background-color":this._getColor(e,k)}).text(d),g[b].empty().adopt(c);var o=10,p={},q=i[b];m=this.gridSize(k),this.entries.each(function(a){var c=new Date(a.startdate_locale),d=new Date(a.enddate_locale);if(""!==a.enddate&&k.isDateBetween(c,d)||""===d&&c.isSameDay(k)){for(var e=this._buildEventOpts({entry:a,curdate:k,divclass:".weekView",tdOffset:b}),f=e.startHour;f<=e.endHour;f++)p[f]="null"===typeOf(p[f])?0:p[f]+1;var g=0;for(f=e.startHour;f<=e.endHour;f++)p[f]>g&&(g=p[f]);var i=Math.max(0,e.startHour-this.options.open);h=q[i],o=Math.floor((h.getSize().x-m)/(m+1)),e.width=o+"px",e["margin-left"]=g*(o+1);var j=this._makeEventRelDiv(a,e,null,h);j.addClass("week-event"),j.inject(document.body);var l=j.css("padding-left").toInt()+j.css("padding-right").toInt();j.css("width",j.css("width").toInt()-l+"px"),j.store("opts",e),j.store("relativeTo",h),j.store("gridSize",m);var n=h.retrieve("calevents",[]);n.push(j),h.store("calevents",n),j.position({relativeTo:h,position:"upperLeft"})}}.bind(this)),k.setTime(k.getTime()+this.DAY)}},_buildEventOpts:function(a){var b=a.curdate,c=new CloneObject(a.entry,!0,["enddate","startdate"]),d=this.el.find(a.divclass+" tr"),e=new Date(c.startdate_locale),f=new Date(c.enddate_locale),g=e.isSameDay(b)?e.getHours()-this.options.open:0;g=0>g?0:g;var h=a.tdOffset;c.label=c.label?c.label:"";var i=d[g+1].find("td")[h+1],j=c.startdate.getHours(),k=i.getSize().y;this.colwidth[a.divclass]=this.colwidth[a.divclass]?this.colwidth[a.divclass]:i.getSize().x;var l=this.el.find(a.divclass).find("tr").getSize().y;colwidth=this.colwidth[a.divclass];var m=colwidth*h;m+=this.el.find(a.divclass).find("td").getSize().x;var n=Math.ceil(f.getHours()-e.getHours());0===n&&(n=1),e.isSameDay(f)||(n=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open+1:24,e.isSameDay(b)?n=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open+1:24-e.getHours():(e.setHours(0),f.isSameDay(b)&&(n=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open:f.getHours()))),l+=k*g;var o=k*n;f.isSameDay(b)&&(o+=f.getMinutes()/60*k),e.isSameDay(b)&&(l+=e.getMinutes()/60*k,o-=e.getMinutes()/60*k);var p=i.find(".fabrikEvent"),q=colwidth/(p.length+1),r=q*p.length;p.css("width",q+"px");a.divclass.substr(1,a.divclass.length);return q-=i.css("border-width").toInt(),a={"z-index":999,"margin-left":r+"px",height:o,view:"weekView","background-color":this._getColor(this.options.colors.headingBg)},a["max-width"]=q+"px",a.left=m,a.top=l,a.color=this._getColor(this.options.colors.headingColor,e),a.startHour=e.getHours(),a.endHour=a.startHour+n,a.startMin=e.getMinutes(),a.endMin=f.getMinutes(),c.startdate.setHours(j),a},removeDayEvents:function(){var a=new Date,b=(new Date).get("gmtoffset").replace(/0+$/,"").toInt(),c=[];a.setTime(this.date.valueOf()),a.setHours(0,0);for(var d=this.el.find(".dayView tr"),e=1;e<d.length;e++){a.setHours(e-1+b,0);var f=d[e].find("td")[1];"null"!==typeOf(f)&&(c.push(f),f.className="",f.addClass("day"),"null"!==typeOf(f.retrieve("calevents"))&&f.retrieve("calevents").each(function(a){a.destroy()}),f.eliminate("calevents"),f.addClass(a.getTime()-this.HOUR),f.set("data-date",a))}return c},showDay:function(){var a,b,c,d=this.el.find(".dayView tr"),e=d[0].childNodes[1].css("background-color");ht=this.options.days[this.date.getDay()],a=$(document.createElement("div")).css({"background-color":this._getColor(e,this.date)}).text(ht),d[0].childNodes[1].empty().adopt(a);var f=this.removeDayEvents(),g=100,h={},i={};this.entries.each(function(a){if(""!==a.enddate&&this.date.isDateBetween(a.startdate,a.enddate)||""===a.enddate&&a.startdate.isSameDay(firstDate))for(var b=this._buildEventOpts({entry:a,curdate:this.date,divclass:".dayView",tdOffset:0}),c=b.startHour;c<=b.endHour;c++)i[c]="null"===typeOf(i[c])?0:i[c]+1}.bind(this));var j=1;Object.each(i,function(a){a>j&&(j=a)}),this.entries.each(function(a){if(""!==a.enddate&&this.date.isDateBetween(a.startdate,a.enddate)||""===a.enddate&&a.startdate.isSameDay(firstDate)){var c=this._buildEventOpts({entry:a,curdate:this.date,divclass:".dayView",tdOffset:0}),d=Math.max(0,c.startHour-this.options.open);b=f[d],g=Math.floor((b.getSize().x-j)/(j+1)),c.width=g+"px";for(var e=c.startHour;e<=c.endHour;e++)h[e]="null"===typeOf(h[e])?0:h[e]+1;var i=0;for(e=c.startHour;e<=c.endHour;e++)h[e]>i&&(i=h[e]);c["margin-left"]=i*(g+1);var k=this._makeEventRelDiv(a,c,null,b);k.addClass("day-event"),k.store("relativeTo",b),k.store("gridSize",j),k.inject(document.body);var l=k.css("padding-left").toInt()+k.css("padding-right").toInt();k.css("width",k.css("width").toInt()-l+"px"),k.store("opts",c);var m=b.retrieve("calevents",[]);m.push(k),b.store("calevents",m),k.position({relativeTo:b,position:"upperLeft"})}}.bind(this)),c=this.date.getDate()+"  "+this.options.months[this.date.getMonth()]+" "+this.date.getFullYear(),this.el.find(".monthDisplay").html(c)},renderMonthView:function(){var a,b,c,d=this.options.first_week_day;this.fadePopWin(0);var e=this._getFirstDayInMonthCalendar(new Date);c=this.options.days.slice(d).concat(this.options.days.slice(0,d));var f=new Date;if(f.setTime(e.valueOf()),e.getDay()!==d){var g=e.getDay()-d;f.setTime(e.valueOf()-24*g*60*60*1e3)}if(this.options.viewType="monthView",this.setAddButtonState(),!this.mothView){for(tbody=$(document.createElement("tbody")).addClass("viewContainerTBody"),b=$(document.createElement("tr")),a=0;7>a;a++)b.adopt($(document.createElement("th")).addClass("dayHeading").css({width:"80px",height:"20px","text-align":"center",color:this._getColor(this.options.colors.headingColor,f),"background-color":this._getColor(this.options.colors.headingBg,f)}).text(c[a])),f.setTime(f.getTime()+this.DAY);tbody.appendChild(b);for(var h=this.options.colors.highlight,i=this.options.colors.bg,j=this.options.colors.today,k=0;6>k;k++){b=$(document.createElement("tr"));var l=this;for(a=0;7>a;a++){var m=this.options.colors.bg,n=this.selectedDate.isSameDay(e)?"selectedDay":"";b.adopt($(document.createElement("td")).addClass("day "+e.getTime()+n).css({width:this.options.monthday.width+"px",height:this.options.monthday.height+"px","background-color":m,"vertical-align":"top",padding:0,border:"1px solid #cccccc"}).on("mouseenter",function(){$(this).css({"background-color":h})}).on("mouseleave",function(){this.set("morph",{duration:500,transition:Fx.Transitions.Sine.easeInOut});var a=this.hasClass("today")?j:i;this.morph({"background-color":[h,a]})}).on("click",function(){l.selectedDate.setTime(this.className.split(" ")[1]),l.date.setTime(l._getTimeFromClassName(this.className)),l.el.find("td").each(function(a){a.removeClass("selectedDay"),a!==this&&a.csss({"background-color":"#F7F7F7"})}.bind(this)),this.addClass("selectedDay")}).on("dblclick",function(a){this.options.readonlyMonth===!1&&self.openAddEvent(a,"month")})),e.setTime(e.getTime()+this.DAY)}tbody.appendChild(b)}this.mothView=$(document.createElement("div")).addClass("monthView").css({position:"relative"}).adopt($(document.createElement("table")).css({"border-collapse":"collapse"}).adopt(tbody)),this.el.find(".viewContainer").appendChild(this.mothView)}this.showView("monthView")},setAddButtonState:function(){var a=this.el.find(".addEventButton");"null"!==typeOf(a)&&("monthView"===this.options.viewType&&this.options.readonlyMonth===!0?a.hide():a.show())},_getTimeFromClassName:function(a){return a.replace("today","").replace("selectedDay","").replace("day","").replace("otherMonth","").trim()},openAddEvent:function(a,b){var c,d,e,f,g,h,i,j;if(this.options.canAdd!==!1&&("monthView"!==this.options.viewType||this.options.readonlyMonth!==!0)&&(a.stopPropagation(),"addEventButton"===a.target.className?(i=new Date,c=i.getTime()):c=this._getTimeFromClassName(a.target.className),this.dateInLimits(c))){a.target.get("data-date")&&console.log("data-date = ",a.target.get("data-date")),this.date.setTime(c);var k=0;isNaN(c)||""===c||(j=new Date,j.setTime(c),g=j.getMonth()+1,g=10>g?"0"+g:g,d=j.getDate(),d=10>d?"0"+d:d,"month"!==b?(e=j.getHours(),e=10>e?"0"+e:e,f=j.getMinutes(),f=10>f?"0"+f:f):(e="00",f="00"),this.doubleclickdate=j.getFullYear()+"-"+g+"-"+d+" "+e+":"+f+":00",k="&jos_fabrik_calendar_events___start_date="+this.doubleclickdate),this.options.eventLists.length>1?this.openChooseEventTypeForm(this.doubleclickdate,c):(h={},h.rowid="",h.id="",k="&"+this.options.eventLists[0].startdate_element+"="+this.doubleclickdate,h.listid=this.options.eventLists[0].value,this.addEvForm(h))}},dateInLimits:function(a){var b=new Date;if(b.setTime(a),""!==this.options.dateLimits.min){var c=new Date(this.options.dateLimits.min);if(c>b)return alert(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_DATE_ADD_TOO_EARLY")),!1}if(""!==this.options.dateLimits.max){var d=new Date(this.options.dateLimits.max);if(b>d)return alert(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_DATE_ADD_TOO_LATE")),!1}return!0},openChooseEventTypeForm:function(a,b){var c="index.php?option=com_fabrik&tmpl=component&view=visualization&controller=visualization.calendar&task=chooseaddevent&id="+this.options.calendarId+"&d="+a+"&rawd="+b;c+="&renderContext="+this.el.id.replace(/visualization_/,""),this.windowopts.contentURL=c,this.windowopts.id="chooseeventwin",this.windowopts.onContentLoaded=function(){new Fx.Scroll(window).toElement("chooseeventwin")},Fabrik.getWindow(this.windowopts)},addEvForm:function(a){"undefined"!=typeof jQuery&&jQuery(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var b="index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=addEvForm&format=raw&listid="+a.listid+"&rowid="+a.rowid;b+="&jos_fabrik_calendar_events___visualization_id="+this.options.calendarId,b+="&visualizationid="+this.options.calendarId,a.nextView&&(b+="&nextview="+a.nextView),b+="&fabrik_window_id="+this.windowopts.id,"undefined"!=typeof this.doubleclickdate&&(b+="&start_date="+this.doubleclickdate),this.windowopts.type="window",this.windowopts.contentURL=b;var c=this.options.filters;this.windowopts.onContentLoaded=function(a){c.each(function(a){switch($("#"+a.key).prop("tagName")){case"SELECT":$("#"+a.key).prop("selectedIndex",a.val);break;case"INPUT":$("#"+a.key).val(a.val)}}),a.fitToContent(!1)}.bind(this),Fabrik.getWindow(this.windowopts)},_highLightToday:function(){var a=new Date;this.el.find(".viewContainerTBody td").each(function(b){var c=new Date(this._getTimeFromClassName(b.className).toInt());a.equalsTo(c)?b.addClass("today"):b.removeClass("today")}.bind(this))},centerOnToday:function(){this.date=new Date,this.showView()},renderDayView:function(){var a,b,c,d,e=this;if(this.fadePopWin(0),this.options.viewType="dayView",this.setAddButtonState(),!this.dayView){for(c=$(document.createElement("tbody")),a=$(document.createElement("tr")),b=0;2>b;b++)a.adopt(0===b?$(document.createElement("td")).addClass("day"):$(document.createElement("th")).addClass("dayHeading").css({width:"80px",height:"20px","text-align":"center",color:this.options.headingColor,"background-color":this.options.colors.headingBg}).text(this.options.days[this.date.getDay()]));for(c.appendChild(a),this.options.open=this.options.open<0?0:this.options.open,this.options.close=this.options.close>24||this.options.close<this.options.open?24:this.options.close,d=this.options.open;d<this.options.close+1;d++){for(a=$(document.createElement("tr")),b=0;2>b;b++)if(0===b){var f=1===d.length?d+"0:00":d+":00";a.adopt($(document.createElement("td")).addClass("day").text(f))}else a.adopt($(document.createElement("td")).addClass("day").css({width:"100%",height:"10px","background-color":"#F7F7F7","vertical-align":"top",padding:0,border:"1px solid #cccccc"}).on("mouseenter",function(){this.css({"background-color":"#FFFFDF"})}).on("mouseleave",function(){this.css({"background-color":"#F7F7F7"})}).on("dblclick",function(a){e.openAddEvent(a,"day")}));c.appendChild(a)}this.dayView=$(document.createElement("div")).addClass("dayView").css({position:"relative"}).adopt($(document.createElement("table")).css({"border-collapse":"collapse"}).adopt(c)),this.el.find(".viewContainer").appendChild(this.dayView)}this.showView("dayView")},hideDayView:function(){this.el.find(".dayView")&&(this.el.find(".dayView").hide(),this.removeDayEvents())},hideWeekView:function(){this.el.find(".weekView")&&(this.el.find(".weekView").hide(),this.removeWeekEvents())},showView:function(){switch(this.hideDayView(),this.hideWeekView(),this.el.find(".monthView")&&this.el.find(".monthView").hide(),this.el.find("."+this.options.viewType).style.display="block",this.options.viewType){case"dayView":this.showDay();break;case"weekView":this.showWeek();break;default:case"monthView":this.showMonth()}Cookie.write("fabrik.viz.calendar.view",this.options.viewType)},renderWeekView:function(){var a,b,c,d,e,f=this;if(this.fadePopWin(0),e=this.options.showweekends===!1?6:8,this.options.viewType="weekView",this.setAddButtonState(),!this.weekView){for(d=$(document.createElement("tbody")),c=$(document.createElement("tr")),b=0;e>b;b++)c.adopt(0===b?$(document.createElement("td")).addClass("day"):$(document.createElement("th")).addClass("dayHeading").css({width:this.options.weekday.width+"px",height:this.options.weekday.height-10+"px","text-align":"center",color:this.options.headingColor,"background-color":this.options.colors.headingBg}).on("click",function(a){a.stopPropagation(),f.selectedDate.setTime(a.target.className.replace("dayHeading ","").toInt());var b=new Date;$(this).parent().parent().find("td").each(function(a){var c=a.className.replace("day ","").replace(" selectedDay").toInt();b.setTime(c),b.getDayOfYear()===this.selectedDate.getDayOfYear()?a.addClass("selectedDay"):a.removeClass("selectedDay")})}).text(this.options.days[b-1]));for(d.appendChild(c),this.options.open=this.options.open<0?0:this.options.open,this.options.close>24||this.options.close<this.options.open?this.options.close=24:this.options.close,a=this.options.open;a<this.options.close+1;a++){for(c=$(document.createElement("tr")),b=0;e>b;b++)if(0===b){var g=1===a.length?a+"0:00":a+":00";c.adopt($(document.createElement("td")).addClass("day").text(g))}else c.adopt($(document.createElement("td")).addClass("day").css({width:this.options.weekday.width+"px",height:this.options.weekday.height+"px","background-color":"#F7F7F7","vertical-align":"top",padding:0,border:"1px solid #cccccc"}).on("mouseenter",function(){$(this).hasClass("selectedDay")||$(this).css({"background-color":"#FFFFDF"})}).on("mouseleave",function(){$(this).hasClass("selectedDay")||$(this).css({"background-color":"#F7F7F7"})}).on("dblclick",function(a){f.openAddEvent(a,"week")}));d.appendChild(c)}this.weekView=$(document.createElement("div")).addClass("weekView").css({position:"relative"}).adopt($(document.createElement("table")).css({"border-collapse":"collapse"}).adopt(d)),this.el.find(".viewContainer").appendChild(this.weekView)}this.showWeek(),this.showView("weekView")},repositionEvents:function(){document.find("a.week-event, a.day-event").each(function(a){var b=a.retrieve("relativeTo");a.position({relativeTo:b,position:"upperLeft"});var c=a.retrieve("gridSize"),d=Math.floor((b.getSize().x-c)/c),e=a.css("padding-left").toInt()+a.css("padding-right").toInt();d-=e,a.css("width",d+"px")})},render:function(a){var b=this;this.setOptions(a),$(window).on("resize",function(){b.repositionEvents()}),this.y=this.el.getPosition().y;var c=function(){var a=this.el.getPosition().y;a!==this.y&&(this.y=a,this.repositionEvents())}.bind(this);window.setInterval(c,200),$(document).on("click","button[data-task=deleteCalEvent], a[data-task=deleteCalEvent]",function(a){a.preventDefault(),b.deleteEntry()}),$(document).on("click","button[data-task=editCalEvent], a[data-task=editCalEvent]",function(a){a.preventDefault(),b.editEntry()}),$(document).on("click","button[data-task=viewCalEvent], a[data-task=viewCalEvent]",function(a){a.preventDefault(),b.activeHoverEvent||(b.activeHoverEvent=$(this).hasClass("fabrikEvent")?$(this):$(this).closest(".fabrikEvent")),b.viewEntry()}),$(document).on("click","a.fabrikEvent)",function(){b.activeHoverEvent=$(this).hasClass("fabrikEvent")?$(this):$(this).closest(".fabrikEvent")}),this.windowopts.title=Joomla.JText._("PLG_VISUALIZATION_CALENDAR_ADD_EDIT_EVENT"),this.windowopts.y=this.options.popwiny,this.popWin=this._makePopUpWin();var d=this.options.urlfilters;d.visualizationid=this.options.calendarId,this.firstRun&&(this.firstRun=!1,d.resetfilters=this.options.restFilterStart),this.el.find(".addEventButton").on("click",function(a){b.openAddEvent(a)});var e=[],f=$(document.createElement("div")).addClass("calendarNav").adopt($(document.createElement("ul")).addClass("viewMode").adopt(e));this.el.appendChild(f),this.el.appendChild($(document.createElement("div")).addClass("viewContainer")),"null"!==typeOf(Cookie.read("fabrik.viz.calendar.date"))&&(this.date=new Date(Cookie.read("fabrik.viz.calendar.date")));var g="null"===typeOf(Cookie.read("fabrik.viz.calendar.view"))?this.options.viewType:Cookie.read("fabrik.viz.calendar.view");switch(g){case"dayView":this.renderDayView();break;case"weekView":this.renderWeekView();break;default:case"monthView":this.renderMonthView()}this.el.find(".nextPage").on("click",function(a){b.nextPage(a)}),this.el.find(".previousPage").on("click",function(a){b.previousPage(a)}),this.options.show_day&&this.el.find(".dayViewLink").on("click",function(a){b.renderDayView(a)}),this.options.show_week&&this.el.find(".weekViewLink").on("click",function(a){b.renderWeekView(a)}),(this.options.show_week||this.options.show_day)&&this.el.find(".monthViewLink").on("click",function(a){b.renderMonthView(a)}),this.el.find(".centerOnToday").on("click",function(a){b.centerOnToday(a)}),this.showMonth(),this.updateEvent()},showMessage:function(a){this.el.find(".calendar-message").html(a),this.fx.showMsg.start({opacity:[0,1]}).chain(function(){this.start.delay(2e3,this,{opacity:[1,0]})})},addEntry:function(a,b){var c,d,e,f;if(b.startdate){if(c=b.startdate.split(" "),c=c[0],""===c.trim())return;if(f=b.startdate.split(" "),f=f[1],f=f.split(":"),c=c.split("-"),d=new Date,e=c[1].toInt()-1,d.setYear(c[0]),d.setMonth(e,c[2]),d.setDate(c[2]),d.setHours(f[0].toInt()),d.setMinutes(f[1].toInt()),d.setSeconds(f[2].toInt()),b.startdate=d,this.entries[a]=b,b.enddate){if(c=b.enddate.split(" "),c=c[0],""===c.trim())return;if("0000-00-00"===c)return void(b.enddate=b.startdate);f=b.enddate.split(" "),f=f[1],f=f.split(":"),c=c.split("-"),d=new Date,e=c[1].toInt()-1,d.setYear(c[0]),d.setMonth(e,c[2]),d.setDate(c[2]),d.setHours(f[0].toInt()),d.setMinutes(f[1].toInt()),d.setSeconds(f[2].toInt()),b.enddate=d}}},deleteEntry:function(){var a=this.activeHoverEvent.id.replace("fabrikEvent_",""),b=a.split("_"),c=b[0];this.options.deleteables.contains(c)&&confirm(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_CONF_DELETE"))&&(this.deleteEvent({id:b[1],listid:c}),$("#"+this.activeHoverEvent).fade("out"),this.fx.showEventActions.start({opacity:[1,0]}),this.removeEntry(a),this.activeDay=null)},editEntry:function(a){var b={};b.id=this.options.formid;var c=this.activeHoverEvent.id.replace("fabrikEvent_","").split("_");b.rowid=c[1],b.listid=c[0],a&&a.stopPropagation(),this.addEvForm(b)},viewEntry:function(){var a={};a.id=this.options.formid;var b=this.activeHoverEvent.id.replace("fabrikEvent_","").split("_");a.rowid=b[1],a.listid=b[0],a.nextView="details",this.addEvForm(a)},addEntries:function(a){jQuery.each(a,function(a,b){this.addEntry(a,b)}.bind(this)),this.showView()},removeEntry:function(a){delete this.entries[a],this.showView()},nextPage:function(){switch(this.fadePopWin(0),this.options.viewType){case"dayView":this.date.setTime(this.date.getTime()+this.DAY),this.showDay();break;case"weekView":this.date.setTime(this.date.getTime()+this.WEEK),this.showWeek();break;case"monthView":this.date.setDate(1),this.date.setMonth(this.date.getMonth()+1),this.showMonth()}Cookie.write("fabrik.viz.calendar.date",this.date)},fadePopWin:function(a){this.popWin&&this.popWin.css("opacity",a)},previousPage:function(){switch(this.fadePopWin(0),this.options.viewType){case"dayView":this.date.setTime(this.date.getTime()-this.DAY),this.showDay();break;case"weekView":this.date.setTime(this.date.getTime()-this.WEEK),this.showWeek();break;case"monthView":this.date.setMonth(this.date.getMonth()-1),this.showMonth()}Cookie.write("fabrik.viz.calendar.date",this.date)},addLegend:function(a){var b=$(document.createElement("ul"));a.each(function(a){var c=$(document.createElement("li"));c.adopt($(document.createElement("div")).css({"background-color":a.colour}),$(document.createElement("span")).text(a.label)),b.appendChild(c)}.bind(this)),$(document.createElement("div")).addClass("calendar-legend").adopt([$(document.createElement("h3")).text(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_KEY")),b]).inject(this.el,"after")},_getGreyscaleFromRgb:function(a){var b=parseInt(a.substring(1,3),16),c=parseInt(a.substring(3,5),16),d=parseInt(a.substring(5),16),e=parseInt(.3*b+.59*c+.11*d,10);return"#"+e.toString(16)+e.toString(16)+e.toString(16)},_getColor:function(a,b){if(!this.options.greyscaledweekend)return a;new Color(a);return"null"===typeOf(b)||0!==b.getDay()&&6!==b.getDay()?a:this._getGreyscaleFromRgb(a)}});Date._MD=new Array(31,28,31,30,31,30,31,31,30,31,30,31),Date.SECOND=1e3,Date.MINUTE=60*Date.SECOND,Date.HOUR=60*Date.MINUTE,Date.DAY=24*Date.HOUR,Date.WEEK=7*Date.DAY,Date.prototype.getMonthDays=function(a){var b=this.getFullYear();return"undefined"==typeof a&&(a=this.getMonth()),0!==b%4||0===b%100&&0!==b%400||1!==a?Date._MD[a]:29},Date.prototype.isSameWeek=function(a){
return this.getFullYear()===a.getFullYear()&&this.getMonth()===a.getMonth()&&this.getWeekNumber()===a.getWeekNumber()},Date.prototype.isSameDay=function(a){return this.getFullYear()===a.getFullYear()&&this.getMonth()===a.getMonth()&&this.getDate()===a.getDate()},Date.prototype.isSameHour=function(a){return this.getFullYear()===a.getFullYear()&&this.getMonth()===a.getMonth()&&this.getDate()===a.getDate()&&this.getHours()===a.getHours()},Date.prototype.isDateBetween=function(a,b){var c=1e4*a.getFullYear()+100*(a.getMonth()+1)+a.getDate(),d=1e4*b.getFullYear()+100*(b.getMonth()+1)+b.getDate(),e=1e4*this.getFullYear()+100*(this.getMonth()+1)+this.getDate();return e>=c&&d>=e};